I"³<h2 id="é¢˜ç›®è¦æ±‚">é¢˜ç›®è¦æ±‚</h2>

<p>ç”¨pthreadå®Œæˆç¨ å¯†çŸ©é˜µå‘é‡ä¹˜æ³•çš„å¹¶è¡Œç®—æ³•ï¼šy=Axï¼Œçº¿ç¨‹æŒ‰è¾“å‡ºæ•°æ®yåˆ’åˆ†ä»»åŠ¡ï¼Œæ¯ä¸ªçº¿ç¨‹è´Ÿè´£è®¡ç®—yçš„m/pä¸ªå…ƒç´ ã€‚</p>

<p>çŸ©é˜µå’Œå‘é‡ä»ç£ç›˜è¯»å…¥ï¼Œç»“æœè¾“å‡ºåˆ°ç£ç›˜ï¼ŒçŸ©é˜µå’Œå‘é‡æ–‡ä»¶æ ¼å¼ç»Ÿä¸€æŒ‰ä¸‰å…ƒç»„å­˜æ”¾ã€‚æµ‹è¯•æ•°æ®è‡ªå·±ç”Ÿæˆå¦‚8,000,000*8çš„çŸ©é˜µã€‚
æµ‹è¯•NUMAéä¸€ç›´è®¿é—®çš„å½±å“ï¼›æµ‹è¯•ä¼ªå…±äº«ã€‚</p>

<h2 id="å®éªŒè¿‡ç¨‹">å®éªŒè¿‡ç¨‹</h2>

<p>å…ˆçœ‹ä¸€ä¸‹è€å¸ˆæä¾›æœºå™¨çš„é…ç½®ï¼š</p>

<pre><code class="language-bash">lnszyd@201-NF5280M3:~$ numactl -H
available: 2 nodes (0-1)
node 0 cpus: 0 1 2 3 4 5 6 7 8 9 10 11 24 25 26 27 28 29 30 31 32 33 34 35
node 0 size: 128924 MB
node 0 free: 106089 MB
node 1 cpus: 12 13 14 15 16 17 18 19 20 21 22 23 36 37 38 39 40 41 42 43 44 45 46 47
node 1 size: 128994 MB
node 1 free: 120915 MB
node distances:
node   0   1
  0:  10  20
  1:  20  10
</code></pre>

<h3 id="mulc">mul.c</h3>

<p>ä¸¤ä¸ªnodeå…±æœ‰48ä¸ªå¯ç”¨çº¿ç¨‹ã€‚ä¸ºäº†ä½“ç°å‡ºNUMAéä¸€è‡´è®¿é—®çš„å½±å“ï¼Œè¿™é‡Œè€ƒè™‘ä½¿ç”¨24ä¸ªçº¿ç¨‹åŠ é€Ÿï¼ˆæ°ç­‰äºæ¯ä¸ªNodeçš„çº¿ç¨‹æ•°ï¼‰ã€‚</p>

<p>å¼€å§‹ç”Ÿæˆ<code>8000000*8</code>çš„çŸ©é˜µæ—¶ï¼Œç”Ÿæˆçš„æ–‡ä»¶å¤§å°å·²ç»é«˜è¾¾6Gï¼Œç„¶è€Œåœ¨è€å¸ˆçš„æœºå™¨ä¸Šå®é™…ä¸Šç”¨äºçŸ©é˜µä¹˜æ³•çš„æ—¶é—´åªæœ‰<code>0.027s</code>ï¼Œä½“ç°ä¸å‡ºå·®å¼‚ã€‚è¿™é‡Œå’Œè€å¸ˆç¡®è®¤ä¹‹åï¼Œç›´æ¥å°†çŸ©é˜µç”Ÿæˆåœ¨å†…å­˜ï¼Œå»æ‰äº†æ–‡ä»¶ï¼ˆå¦‚æœè¦ä½¿ç”¨æ–‡ä»¶ï¼Œåªéœ€è¦å»æ‰æˆ‘ä»£ç ä¸­çš„æ³¨é‡Šéƒ¨åˆ†å³å¯ï¼‰ã€‚</p>

<p>æ­¤å¤–ï¼Œå°†çŸ©é˜µå¤§å°æ‰©å¤§åˆ°<code>240000000*8</code>ï¼ˆè¡Œæ•°å¢åŠ ä¸‰åå€ï¼‰ï¼Œç»ˆäºèƒ½å¤Ÿåœ¨è¿è¡Œæ—¶ä½“ç°ä¸€ç‚¹ç‚¹çš„åŒºåˆ«ï¼ˆå†…å­˜å ç”¨çº¦7.5Gï¼Œæ°ç•¥å°äºæ¯ä¸ªNodeçš„ç©ºé—²å†…å­˜ï¼Œä¸ä¼šå¼•èµ·å†…å­˜é¡µè¢«SWAPåˆ°ç¡¬ç›˜ä¸Šå¯¼è‡´å‡é€Ÿï¼‰ã€‚</p>

<p>æ­¤å¤–ï¼Œè¦æ³¨æ„çš„æ˜¯ï¼Œè¦ä½¿ç”¨çº¿ç¨‹å®‰å…¨çš„è®¡æ—¶å‡½æ•°ã€‚è¿™é‡Œä½¿ç”¨äº†OpenMPä¸­çš„<code>omp_get_wtime()</code>ã€‚</p>

<pre><code class="language-cpp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;pthread.h&gt;
#include &lt;omp.h&gt;
int m, n, numThreads, *y, *a, *x; // row, col, number of threads, y=ax
void *threadMul(void *rank)
{
	for (int block = (m + numThreads - 1) / numThreads, i = (int)rank * block, ie = i + block &lt; m ? i + block : m; i &lt; ie; ++i)
		for (int j = y[i] = 0; j &lt; n; ++j)
			y[i] += a[i * n + j] * x[j];
	return NULL;
}
int main(int argc, char *argv[])
{
	m = atoi(argv[1]), n = atoi(argv[2]), numThreads = atoi(argv[3]);
	a = malloc(m * n * sizeof(int));
	x = malloc(n * sizeof(int));
	y = malloc(m * sizeof(int));
	for (int i = 0; i &lt; n; ++i)
		x[i] = rand();
	for (int i = 0; i &lt; m * n; ++i)
		a[i] = rand();
	/*
	FILE *arrinput = fopen(argv[4], "r"), *vecinput = fopen(argv[5], "r");
	for (int i, j; fscanf(arrinput, "%d%d", &amp;i, &amp;j) != EOF;)
		fscanf(arrinput, "%d", &amp;a[i * n + j]);
	for (int i, j; fscanf(vecinput, "%d%d", &amp;i, &amp;j) != EOF;)
		fscanf(vecinput, "%d", &amp;x[i]);
	fclose(arrinput), fclose(vecinput);
	*/
	double start = omp_get_wtime();
	pthread_t *thread_handles = malloc(numThreads * sizeof(pthread_t));
	for (int i = 0; i &lt; numThreads; ++i)
		pthread_create(&amp;thread_handles[i], NULL, threadMul, (void *)i);
	for (int i = 0; i &lt; numThreads; ++i)
		pthread_join(thread_handles[i], NULL);
	free(thread_handles);
	printf("elapsed time: %f s", omp_get_wtime() - start);
	/*
	FILE *output = fopen(argv[6], "w");
	for (int i = 0; i &lt; m; i++)
		fprintf(output, "%d ", y[i]);
	fclose(output);
	*/
	free(a), free(x), free(y);
}
</code></pre>

<h3 id="æ•°æ®ç”Ÿæˆå™¨">æ•°æ®ç”Ÿæˆå™¨</h3>

<pre><code class="language-c">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;pthread.h&gt;
int main(int argc, char *argv[])
{
	FILE *output = fopen(argv[1], "w");
	int m = atoi(argv[2]), n = atoi(argv[3]);
	for (int i = 0; i &lt; m; ++i)
		for (int j = 0; j &lt; n; ++j)
			fprintf(output, "%d %d %d\n", i, j, rand());
	fclose(output);
}
</code></pre>

<h3 id="è¿è¡Œ">è¿è¡Œ</h3>

<pre><code class="language-bash">lnszyd@201-NF5280M3:~$ gcc -lpthread -fopenmp -o mul mul.c
lnszyd@201-NF5280M3:~$ time ./mul 240000000 8 24
elapsed time: 0.825514 s
real    0m26.875s
user    0m40.572s
sys     0m4.357s
lnszyd@201-NF5280M3:~$ time numactl --interleave=all ./mul 240000000 8 24
elapsed time: 0.793493 s
real    0m28.699s
user    0m38.905s
sys     0m6.258s
lnszyd@201-NF5280M3:~$ time numactl -N 0 -m 0 ./mul 240000000 8 24
elapsed time: 0.796528 s
real    0m26.820s
user    0m40.939s
sys     0m4.029s
lnszyd@201-NF5280M3:~$ time numactl -N 0 -m 1 ./mul 240000000 8 24
elapsed time: 0.842660 s
real    0m28.698s
user    0m41.000s
sys     0m6.913s
</code></pre>

<p>å¦‚ä¸Šï¼Œå½“ä½¿ç”¨Node 0çš„CPUä½†æ˜¯ä½¿ç”¨Node 1çš„å†…å­˜æ—¶ï¼Œè¿è¡Œæ—¶é—´æœ€é•¿ï¼›å…¶æ¬¡æ˜¯æŒ‰é»˜è®¤æƒ…å†µè¿è¡Œï¼›<code>numactl -N 0 -m 0</code>å’Œ<code>numactl -N 0 -m 0</code>éƒ½å–å¾—äº†ä¸€å®šçš„æå‡ï¼Œå‰è€…æ˜¯å°†å†…å­˜éšæœºå‡åŒ€åˆ†å¸ƒåœ¨æ•´ä¸ªå†…å­˜ï¼Œè€Œåè€…ç»‘å®šNode 0çš„å†…å­˜å’ŒCPUã€‚</p>

<p>ä¸‹é¢æµ‹å®šè®¿å­˜ä¸€è‡´æ€§å’Œä¼ªå…±äº«ã€‚ä»¥ä¸‹æ˜¯0å·Nodeè®¿é—®0å·nodeå¯¹åº”å†…å­˜çš„è®°å½•ã€‚</p>

<pre><code class="language-bash">lnszyd@201-NF5280M3:~$ sudo perf c2c record  numactl -N 0 -m 0 ./mul 240000000 8 24
elapsed time: 0.905527 s[ perf record: Woken up 44 times to write data ]
[ perf record: Captured and wrote 11.816 MB perf.data (140452 samples) ]
lnszyd@201-NF5280M3:~$ sudo perf c2c report
</code></pre>

<p>ä»¥ä¸‹æ˜¯0å·Nodeè®¿é—®1å·nodeå¯¹åº”å†…å­˜çš„è®°å½•ã€‚å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œçš„å¹³å‡å»¶è¿Ÿå¤§äº†å¾ˆå¤šã€‚</p>

<pre><code class="language-bash">lnszyd@201-NF5280M3:~$ sudo perf c2c record  numactl -N 0 -m 1 ./mul 240000000 8 24
elapsed time: 0.929291 s[ perf record: Woken up 44 times to write data ]
[ perf record: Captured and wrote 11.267 MB perf.data (133906 samples) ]
lnszyd@201-NF5280M3:~$ sudo perf c2c report
</code></pre>
:ET