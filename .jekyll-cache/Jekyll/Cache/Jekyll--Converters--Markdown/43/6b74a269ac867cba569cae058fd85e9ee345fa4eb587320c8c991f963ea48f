I"İ#<h4 id="ä»€ä¹ˆæ˜¯æµè§ˆå™¨çš„åŒæºç­–ç•¥">ä»€ä¹ˆæ˜¯æµè§ˆå™¨çš„åŒæºç­–ç•¥</h4>
<p>åŒæºæŒ‡çš„æ˜¯â€åè®®+åŸŸå+ç«¯å£â€ä¸‰è€…ç›¸åŒï¼Œå³ä½¿ä¸¤ä¸ªä¸åŒçš„åŸŸåæŒ‡å‘åŒä¸€ä¸ªipåœ°å€ï¼Œä¹Ÿé</p>

<p>åŒæºã€‚åŒæºç­–ç•¥æ˜¯æµè§ˆå™¨æœ€æ ¸å¿ƒä¹Ÿæ˜¯æœ€åŸºæœ¬çš„å®‰å…¨åŠŸèƒ½ï¼Œå¦‚æœç¼ºå°‘äº†åŒæºç­–ç•¥ï¼Œæµè§ˆå™¨å¾ˆå®¹æ˜“å—åˆ°</p>

<p>XSSï¼Œcsrfæ”»å‡»ã€‚</p>

<p>åŒæºç­–ç•¥é™åˆ¶ä»¥ä¸‹å‡ ç§è¡Œä¸º:</p>
<ul>
  <li>Cookieã€LocalStorageå’ŒIndexDBæ— æ³•è¯»å–</li>
  <li>Domå’ŒJSå¯¹è±¡æ— æ³•è·å¾—</li>
  <li>AJAXè¯·æ±‚ä¸èƒ½å‘é€</li>
</ul>

<p>å¸¸è§çš„è·¨åŸŸåœºæ™¯:</p>

<table>
  <tbody>
    <tr>
      <td>URL</td>
      <td>è¯´æ˜</td>
      <td>æ˜¯å¦å…è®¸é€šä¿¡</td>
    </tr>
  </tbody>
</table>

<table>
  <tbody>
    <tr>
      <td>http://www.domain.com/a.js</td>
      <td>Â </td>
    </tr>
  </tbody>
</table>

<table>
  <tbody>
    <tr>
      <td>http://www.domain.com/b.js</td>
      <td>Â </td>
    </tr>
  </tbody>
</table>

<table>
  <tbody>
    <tr>
      <td>http://www.domain.com/lab/c.js</td>
      <td>åŒä¸€åŸŸåï¼Œä¸åŒæ–‡ä»¶æˆ–è·¯å¾„</td>
      <td>å…è®¸</td>
    </tr>
  </tbody>
</table>

<table>
  <tbody>
    <tr>
      <td>http://www.domain.com:8000/a.js</td>
      <td>Â </td>
      <td>Â </td>
    </tr>
  </tbody>
</table>

<table>
  <tbody>
    <tr>
      <td>http://www.domain.com/b.js</td>
      <td>åŒä¸€åŸŸåï¼Œä¸åŒç«¯å£</td>
      <td>ä¸å…è®¸</td>
    </tr>
  </tbody>
</table>

<table>
  <tbody>
    <tr>
      <td>http://www.domain.com/a.js</td>
      <td>Â </td>
      <td>Â </td>
    </tr>
  </tbody>
</table>

<table>
  <tbody>
    <tr>
      <td>https://www.domain.com/b.js</td>
      <td>åŒä¸€åŸŸåï¼Œä¸åŒåè®®</td>
      <td>ä¸å…è®¸</td>
    </tr>
  </tbody>
</table>

<table>
  <tbody>
    <tr>
      <td>http://www.domain.com/a.js</td>
      <td>Â </td>
      <td>Â </td>
    </tr>
  </tbody>
</table>

<table>
  <tbody>
    <tr>
      <td>http://192.168.4.12/b.js</td>
      <td>åŸŸåå’ŒåŸŸåå¯¹åº”ç›¸åŒip</td>
      <td>ä¸å…è®¸</td>
    </tr>
  </tbody>
</table>

<table>
  <tbody>
    <tr>
      <td>http://www.domain.com/a.js</td>
      <td>Â </td>
      <td>Â </td>
    </tr>
  </tbody>
</table>

<table>
  <tbody>
    <tr>
      <td>http://x.domain.com/b.js</td>
      <td>Â </td>
    </tr>
  </tbody>
</table>

<table>
  <tbody>
    <tr>
      <td>http://domain.com/c.js</td>
      <td>ä¸»åŸŸç›¸åŒï¼Œå­åŸŸä¸åŒ</td>
      <td>ä¸å…è®¸</td>
    </tr>
  </tbody>
</table>

<table>
  <tbody>
    <tr>
      <td>http://www.domain1.com/a.js</td>
      <td>Â </td>
      <td>Â </td>
    </tr>
  </tbody>
</table>

<table>
  <tbody>
    <tr>
      <td>http://www.domain2.com/b.js</td>
      <td>ä¸åŒåŸŸå</td>
      <td>ä¸å…è®¸</td>
    </tr>
  </tbody>
</table>

<p>ä¸»åŸŸåå’Œå­åŸŸå:</p>

<p>ä¸»åŸŸå: abc.com</p>

<p>wwww.abc.com // wwwæ˜¯å­åŸŸå</p>

<p>bbs.abc.com // bbsæ˜¯ä¸»åŸŸå</p>

<p>beijing.bbs.abc.com //beijing.bbsæ˜¯å­åŸŸå</p>

<p>haidian.beijing.bbs.abc.com //haidian.beijing.bbsæ˜¯å­åŸŸå</p>

<p>ä¸»åŸŸåæ˜¯ä¸å¸¦wwwçš„åŸŸåï¼Œä¾‹å¦‚a.comï¼Œä¸»åŸŸåå‰é¢å¸¦å‰ç¼€çš„é€šå¸¸éƒ½ä¸ºäºŒçº§åŸŸåæˆ–å¤šçº§åŸŸåï¼Œä¾‹å¦‚www.a.comå…¶å®æ˜¯äºŒçº§åŸŸåã€‚</p>

<h4 id="è·¨åŸŸè§£å†³æ–¹æ¡ˆ">è·¨åŸŸè§£å†³æ–¹æ¡ˆ</h4>
<ol>
  <li>é€šè¿‡jsonpå®ç°è·¨åŸŸ</li>
  <li>è·¨åŸŸèµ„æºå…±äº«(CORS)</li>
  <li>document.domain+ iframeè·¨åŸŸ</li>
  <li>location.hash + iframe</li>
  <li>window.name +iframe</li>
  <li>postMessageè·¨åŸŸ</li>
  <li>nginxä»£ç†è·¨åŸŸ</li>
  <li>nodexjsä¸­é—´ä»¶ä»£ç†è·¨åŸŸ</li>
  <li>websocketåè®®è·¨åŸŸ</li>
</ol>

<h5 id="ä¸€jsonpå®ç°è·¨åŸŸ">ä¸€ã€jsonpå®ç°è·¨åŸŸ</h5>

<ol>
  <li>
    <p>åŸç†</p>

    <p>è™½ç„¶æµè§ˆå™¨é»˜è®¤ç¦æ­¢äº†è·¨åŸŸè®¿é—®ï¼Œä½†æ˜¯å¹¶ä¸ç¦æ­¢åœ¨é¡µé¢ä¸­çš„scriptæ ‡ç­¾å¼•ç”¨å…¶ä»–åŸŸä¸‹çš„JSæ–‡ä»¶ã€‚</p>

    <p>æ ¹æ®è¿™ä¸€ç‚¹ï¼Œå¯ä»¥æ–¹ä¾¿åœ°é€šè¿‡åŠ¨æ€åˆ›å»ºscriptèŠ‚ç‚¹çš„æ–¹æ³•æ¥å®ç°å®Œå…¨è·¨åŸŸçš„é€šä¿¡ã€‚</p>
  </li>
  <li>
    <p>ä»£ç å®ç°</p>
  </li>
</ol>

<ul>
  <li>åŸç”Ÿ
    <pre><code> &lt;script&gt;
  var script = document.createElement('script');
  script.type = 'text/javascript';

  // ä¼ å‚ä¸€ä¸ªå›è°ƒå‡½æ•°åç»™åç«¯ï¼Œæ–¹ä¾¿åç«¯è¿”å›æ—¶æ‰§è¡Œè¿™ä¸ªåœ¨å‰ç«¯å®šä¹‰çš„å›è°ƒå‡½æ•°
  script.src = 'http://www.domain2.com:8080/login?user=admin&amp;callback=handleCallback';
  document.head.appendChild(script);

  // å›è°ƒæ‰§è¡Œå‡½æ•°
  function handleCallback(res) {
      alert(JSON.stringify(res));
  }
 &lt;/script&gt;
</code></pre>
  </li>
  <li>vue.js</li>
</ul>

<pre><code>    this.$http.jsonp('http://www.domain2.com:8080/login', {
        params: {},
        jsonp: 'handleCallback'
    }).then((res) =&gt; {
        console.log(res); 
    })
</code></pre>

<ul>
  <li>åç«¯node.jså®ç°</li>
</ul>

<pre><code>    var querystring = require('querystring');
    var http = require('http');
    var server = http.createServer();

    server.on('request', function(req, res) {
        var params = qs.parse(req.url.split('?')[1]);
        var fn = params.callback;

        // jsonpè¿”å›è®¾ç½®
        res.writeHead(200, { 'Content-Type': 'text/javascript' });
        res.write(fn + '(' + JSON.stringify(params) + ')');

        res.end();
    });

    server.listen('8080');
    console.log('Server is running at port 8080...');
</code></pre>

<ol>
  <li>ç¼ºç‚¹</li>
</ol>

<p>åªèƒ½å®ç°getä¸€ç§è¯·æ±‚</p>

<h4 id="è·¨åŸŸèµ„æºå…±äº«cors">è·¨åŸŸèµ„æºå…±äº«(CORS)</h4>

<p>æ™®é€šè·¨åŸŸè¯·æ±‚åªéœ€æœåŠ¡ç«¯è®¾ç½®Access-Control-Allow-Originå³å¯ï¼Œå‰ç«¯æ— éœ€è®¾ç½®ï¼Œè‹¥è¦</p>

<p>å¸¦cookieè¯·æ±‚ï¼Œåˆ™å‰åç«¯è¦è¦è®¾ç½®cookieç›¸å…³é…ç½®ã€‚ç”±äºåŒæºç­–ç•¥çš„é™åˆ¶ï¼Œæ‰€è¯»å–çš„cookieä¸º</p>

<p>è·¨åŸŸè¯·æ±‚æ¥å£æ‰€åœ¨çš„cookieï¼Œè€Œéå½“å‰é¡µã€‚è‹¥æƒ³å®ç°å½“å‰é¡µcookieçš„å†™å…¥ï¼Œå¯ä»¥å‚è€ƒä¸‹é¢çš„æ–¹æ³•:</p>

<p>nginxåå‘ä»£ç†ä¸­è®¾ç½®proxy_cookie_domainå’ŒNodeJsä¸­é—´ä»¶ä»£ç†ä¸­cookieDomainRewriteå‚æ•°çš„è®¾ç½®ã€‚</p>

<p>ç›®å‰ï¼Œæ‰€æœ‰çš„æµè§ˆå™¨éƒ½æ”¯æŒè¯¥åŠŸèƒ½ï¼Œcorså·²ç»æˆä¸ºä¸»æµçš„è·¨åŸŸè§£å†³æ–¹æ¡ˆã€‚</p>

<ol>
  <li>å‰ç«¯è®¾ç½®</li>
</ol>

<pre><code>var xhr = new XMLHttpRequest(); // IE8/9éœ€ç”¨window.XDomainRequestå…¼å®¹

// å‰ç«¯è®¾ç½®æ˜¯å¦å¸¦cookie
xhr.withCredentials = true;

xhr.open('post', 'http://www.domain2.com:8080/login', true);
xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
xhr.send('user=admin');

xhr.onreadystatechange = function() {
    if (xhr.readyState == 4 &amp;&amp; xhr.status == 200) {
        alert(xhr.responseText);
    }
};
</code></pre>

<ol>
  <li>åç«¯è®¾ç½®</li>
</ol>

<pre><code>var http = require('http');
var server = http.createServer();
var qs = require('querystring');

server.on('request', function(req, res) {
    var postData = '';

    // æ•°æ®å—æ¥æ”¶ä¸­
    req.addListener('data', function(chunk) {
        postData += chunk;
    });

    // æ•°æ®æ¥æ”¶å®Œæ¯•
    req.addListener('end', function() {
        postData = qs.parse(postData);

        // è·¨åŸŸåå°è®¾ç½®
        res.writeHead(200, {
            'Access-Control-Allow-Credentials': 'true',     // åç«¯å…è®¸å‘é€Cookie
            'Access-Control-Allow-Origin': 'http://www.domain1.com',    // å…è®¸è®¿é—®çš„åŸŸï¼ˆåè®®+åŸŸå+ç«¯å£ï¼‰
            /* 
             * æ­¤å¤„è®¾ç½®çš„cookieè¿˜æ˜¯domain2çš„è€Œédomain1ï¼Œå› ä¸ºåç«¯ä¹Ÿä¸èƒ½è·¨åŸŸå†™cookie(nginxåå‘ä»£ç†å¯ä»¥å®ç°)ï¼Œ
             * ä½†åªè¦domain2ä¸­å†™å…¥ä¸€æ¬¡cookieè®¤è¯ï¼Œåé¢çš„è·¨åŸŸæ¥å£éƒ½èƒ½ä»domain2ä¸­è·å–cookieï¼Œä»è€Œå®ç°æ‰€æœ‰çš„æ¥å£éƒ½èƒ½è·¨åŸŸè®¿é—®
             */
            'Set-Cookie': 'l=a123456;Path=/;Domain=www.domain2.com;HttpOnly'  // HttpOnlyçš„ä½œç”¨æ˜¯è®©jsæ— æ³•è¯»å–cookie
        });

        res.write(JSON.stringify(postData));
        res.end();
    });
});

server.listen('8080');
console.log('Server is running at port 8080...');
</code></pre>

<h4 id="documentdomain--iframeè·¨åŸŸ">document.domain + iframeè·¨åŸŸ</h4>

<p>æ­¤æ–¹æ¡ˆä»…é™ä¸»åŸŸç›¸åŒï¼Œè€Œå­åŸŸä¸åŒçš„è·¨åŸŸåº”ç”¨åœºæ™¯.</p>

<p>å®ç°åŸç†: ä¸¤ä¸ªé¡µé¢éƒ½é€šè¿‡jså¼ºåˆ¶è®¾ç½®document.domainä¸ºåŸºç¡€ä¸»åŸŸï¼Œå°±å®ç°äº†åŒåŸŸ.</p>

<ol>
  <li>çˆ¶çª—å£: ï¼ˆhttp://www.domain.com/a.htmlï¼‰</li>
</ol>

<pre><code>&lt;iframe id="iframe" src="http://child.domain.com/b.html"&gt;&lt;/iframe&gt;
&lt;script&gt;
    document.domain = 'domain.com';
    var user = 'admin';
&lt;/script&gt;
</code></pre>

<ol>
  <li>å­çª—å£: (http://www.child.domain.com/b.html)
    <pre><code>&lt;script&gt;
 document.domain = 'domain.com';
 // è·å–çˆ¶çª—å£ä¸­å˜é‡
 alert('get js data from parent ---&gt; ' + window.parent.user);
&lt;/script&gt;
</code></pre>
  </li>
</ol>

<h4 id="locationhash--iframe-è·¨åŸŸ">location.hash + iframe è·¨åŸŸ</h4>

<ol>
  <li>å®ç°åŸç†</li>
</ol>

<p>aæ¬²ä¸bè·¨åŸŸç›¸äº’é€šä¿¡ï¼Œé€šè¿‡ä¸­é—´é¡µcæ¥å®ç°ã€‚ ä¸‰ä¸ªé¡µé¢ï¼Œä¸åŒåŸŸä¹‹é—´åˆ©ç”¨iframeçš„location.hashä¼ å€¼ï¼Œç›¸åŒåŸŸä¹‹é—´ç›´æ¥jsè®¿é—®æ¥é€šä¿¡.</p>

<p>åŒæ—¶ï¼Œæ”¹å˜hashå€¼å¹¶ä¸ä¼šå¯¼è‡´é¡µé¢åˆ·æ–°ã€‚</p>

<ol>
  <li>ä»£ç å®ç°</li>
</ol>

<p>a.html(http://www.domain1.com/a.html)</p>

<h4 id="å‚è€ƒæ–‡ç« ">å‚è€ƒæ–‡ç« </h4>

<ol>
  <li>https://segmentfault.com/a/1190000015764619</li>
  <li>https://segmentfault.com/a/1190000011145364</li>
</ol>

:ET