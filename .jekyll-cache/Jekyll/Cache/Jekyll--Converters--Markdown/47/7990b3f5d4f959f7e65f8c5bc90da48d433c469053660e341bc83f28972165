I"å<h2 id="é¢˜ç›®è¦æ±‚">é¢˜ç›®è¦æ±‚</h2>

<p>å°†æ–‡ä»¶â€œæ€§èƒ½ä¼˜åŒ–å®éªŒåˆ†æ.pdfâ€ä¸­è®¨è®ºçš„ç¨‹åºç¼–è¯‘è¿è¡Œï¼Œå¹¶è®°å½•è¿è¡Œæ—¶é—´ï¼Œç„¶ååˆ©ç”¨Linuxæ€§èƒ½å‰–æå·¥å…·perfåˆ†æç¨‹åºè¢«åŠ é€Ÿçš„åŸå› ã€‚</p>

<h2 id="å®éªŒè¿‡ç¨‹">å®éªŒè¿‡ç¨‹</h2>

<pre><code class="language-c">#include &lt;stdio.h&gt;
typedef struct pixel
{
	int red, green, blue;
} pixel;
#define RIDX(i, j, dim) ((i) * (dim) + (j))
void naive_rotate(int dim, pixel *src, pixel *dst)
{
	int i, j;
	for (i = 0; i &lt; dim; i++)
		for (j = 0; j &lt; dim; j++)
			dst[RIDX(dim - 1 - j, i, dim)] = src[RIDX(i, j, dim)];
}
void rotate1(int dim, pixel *src, pixel *dst)
{
	int i, j, ii, jj;
	for (ii = 0; ii &lt; dim; ii += 4)
		for (jj = 0; jj &lt; dim; jj += 4)
			for (i = ii; i &lt; ii + 4; i++)
				for (j = jj; j &lt; jj + 4; j++)
					dst[RIDX(dim - 1 - j, i, dim)] = src[RIDX(i, j, dim)];
}
void rotate2(int dim, pixel *src, pixel *dst)
{
	int i, j, ii, jj, k;
	for (ii = 0; ii &lt; dim; ii += 32)
		for (jj = 0; jj &lt; dim; jj += 32)
			for (i = ii; i &lt; ii + 32; i += 4)
				for (j = jj; j &lt; jj + 32; j += 4)
					for (k = j; k &lt; j + 4; ++k)
					{
						dst[RIDX(dim - 1 - k, i, dim)] = src[RIDX(i, k, dim)];
						dst[RIDX(dim - 1 - k, i + 1, dim)] = src[RIDX(i + 1, k, dim)];
						dst[RIDX(dim - 1 - k, i + 2, dim)] = src[RIDX(i + 2, k, dim)];
						dst[RIDX(dim - 1 - k, i + 3, dim)] = src[RIDX(i + 3, k, dim)];
					}
}
#define COPY(d, s) *(d) = *(s)
void rotate3(int dim, pixel *src, pixel *dst)
{
	int i, j, k;
	for (i = 0; i &lt; dim; i += 32)
		for (j = dim - 1; j &gt;= 0; j -= 1)
		{
			pixel *dptr = dst + RIDX(dim - 1 - j, i, dim);
			pixel *sptr = src + RIDX(i, j, dim);
			for (k = 0; k &lt; 32; ++k)
			{
				COPY(dptr + k, sptr);
				sptr += dim;
			}
		}
}
#define N (1 &lt;&lt; 13)
pixel s[N * N], d[N * N];
int main()
{
	naive_rotate(N, s, d);
	rotate1(N, s, d);
	rotate2(N, s, d);
	rotate3(N, s, d);
}
</code></pre>

<p>åœ¨è€å¸ˆæä¾›çš„æœºå™¨ä¸Šè¿è¡Œä¸‹è¿°æŒ‡ä»¤ï¼ˆåªæˆªå–äº†æŠ¥å‘Šä¸­å’Œä¼˜åŒ–éƒ¨åˆ†ç›¸å…³çš„ä¸‰ä¸ªå‡½æ•°ï¼‰ã€‚</p>

<pre><code class="language-bash">lnszyd@201-NF5280M3:~$ gcc -g a.c
lnszyd@201-NF5280M3:~$ sudo perf record -g ./a.out
[ perf record: Woken up 10 times to write data ]
[ perf record: Captured and wrote 2.468 MB perf.data (28285 samples) ]
lnszyd@201-NF5280M3:~$ sudo perf report -g -i perf.data
-   52.13%    47.82%  a.out    a.out              [.] naive_rotate
   + 47.82% 0x2be258d4c544155
   - 4.31% naive_rotate
      - 2.48% page_fault
         - 2.48% do_page_fault
            - 2.41% __do_page_fault
               - 2.23% handle_mm_fault
                  - 1.87% __handle_mm_fault
                     - 1.31% alloc_pages_vma
                        - 1.30% __alloc_pages_nodemask
                             1.12% clear_page_erms
      - 0.77% swapgs_restore_regs_and_return_to_usermode
           prepare_exit_to_usermode
-   24.30%    23.90%  a.out    a.out              [.] rotate1
     23.90% 0x2be258d4c544155
        __libc_start_main
        main
        rotate1
-   11.86%    11.68%  a.out    a.out              [.] rotate3
     11.68% 0x2be258d4c544155
        __libc_start_main
        main
        rotate3
-   11.72%    11.49%  a.out    a.out              [.] rotate2
     11.49% 0x2be258d4c544155
        __libc_start_main
        main
        rotate2
</code></pre>

<p>å¯ä»¥çœ‹åˆ°ï¼Œå‡½æ•°æŒ‰ç…§è¿è¡Œæ—¶é—´ä»å¤§åˆ°å°çš„æ’åˆ—ä¾æ¬¡ä¸º<code>naive_rotate</code>ã€<code>rotate1</code>ã€<code>rotate_3</code>ã€<code>rotate2</code>ã€‚</p>

<p>åˆ†æå…·ä½“åŸå› ï¼š<code>rotate1</code>ç›¸å¯¹äº<code>naive_rotate</code>ï¼ŒæŒ‰ç…§<code>4*4</code>çš„å¤§å°å¯¹çŸ©å½¢åˆ†å—ï¼Œæé«˜äº†ç¼“å­˜è®¿é—®çš„å±€éƒ¨æ€§ã€‚è€Œ<code>rotate2</code>ç›¸å¯¹äº<code>rotate1</code>åˆ†å—æ›´å¤§ï¼Œå› æ­¤æ‹¥æœ‰æ›´å¥½çš„å†…å­˜å±€éƒ¨æ€§ï¼Œè¿›ä¸€æ­¥å‡å°‘äº†Cache Missã€‚è€Œ<code>rotate3</code>ä¸<code>rotate2</code>ç›¸æ¯”è¿è¡Œæ—¶é—´å‡ ä¹æ²¡æœ‰å˜åŒ–ï¼Œæ¨æµ‹åœ¨è¿™ä¸ªè¿è¡Œç¯å¢ƒä¸Šå­˜å‚¨å™¨å†™æ—¶é—´çš„å½±å“ä¸æ˜¯å¾ˆå¤§ï¼Œè°ƒæ•´å†™åœ°å€è¿ç»­æ²¡æœ‰å¸¦æ¥å¾ˆå¤§æ”¶ç›Šã€‚</p>

<p>æ­¤å¤–ï¼Œå½“è°ƒå°Nè‡³<code>1 &lt;&lt; 8</code>æ—¶ï¼Œä¼šå¾—åˆ°å®Œå…¨ä¸åŒçš„ç»“æœï¼ˆ<code>rotate3</code>é€Ÿåº¦è¿œæ…¢äº<code>naive_rotate</code>ï¼‰ã€‚è¿™è¯´æ˜ï¼Œè°ƒæ•´çŸ©é˜µåˆ†å—çš„æ—¶å€™éœ€è¦æ ¹æ®å…·ä½“æœºå™¨çš„ç¼“å­˜é…ç½®æ¥å†³å®šï¼Œå¦åˆ™åè€Œä¼šå¸¦æ¥é¢å¤–çš„å¼€é”€ã€‚</p>
:ET