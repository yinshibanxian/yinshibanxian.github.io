I"‹$<h2 id="å®éªŒé¢˜ç›®">å®éªŒé¢˜ç›®</h2>

<p>Chatå®éªŒ</p>

<h2 id="å®éªŒç›®çš„">å®éªŒç›®çš„</h2>

<p>æŒæ¡å¥—èŠ‚å­—çš„å¤šçº¿ç¨‹ç¼–ç¨‹æ–¹æ³•ã€‚</p>

<h2 id="å®éªŒä»‹ç»">å®éªŒä»‹ç»</h2>

<p>åˆ©ç”¨å®¢æˆ·/æœåŠ¡å™¨(Client/Severæˆ–CS)æ¨¡å¼å®ç°ä¸€ä¸ªå¤šäººèŠå¤©(ç¾¤èŠ)ç¨‹åºã€‚å…¶åŠŸèƒ½æ˜¯æ¯ä¸ªå®¢æˆ·å‘é€ç»™æœåŠ¡å™¨çš„æ¶ˆæ¯éƒ½ä¼šä¼ é€ç»™æ‰€æœ‰çš„å®¢æˆ·ç«¯ã€‚</p>

<pre><code class="language-mermaid">graph TB
æœåŠ¡å™¨--Hello--&gt;A
A==Hello==&gt;æœåŠ¡å™¨
æœåŠ¡å™¨--Hello--&gt;B
æœåŠ¡å™¨--Hello--&gt;C
æœåŠ¡å™¨--Hello--&gt;D
</code></pre>

<h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2>

<ul>
  <li>https://docs.microsoft.com/en-us/windows/desktop/WinSock/getting-started-with-winsock ï¼ˆå¥—æ¥å­—ï¼‰</li>
  <li>https://www.cnblogs.com/hgwang/p/6074038.html  ï¼ˆå¥—æ¥å­—ï¼‰</li>
  <li>https://www.jb51.net/article/37410.htm  ï¼ˆå­—ç¬¦ä¸²ï¼‰</li>
  <li>https://docs.microsoft.com/en-us/cpp/c-runtime-library/stream-i-o?view=vs-2017  ï¼ˆå­—ç¬¦ä¸²ï¼‰</li>
  <li>https://docs.microsoft.com/en-us/cpp/c-runtime-library/reference/crt-alphabetical-function-reference?view=vs-2017#s   ï¼ˆå­—ç¬¦ä¸²ï¼‰</li>
  <li>http://www.runoob.com/cprogramming/  ï¼ˆå­—ç¬¦ä¸²ï¼‰</li>
  <li>ä¾‹ç¨‹â€œ_beginthreadexâ€  		ï¼ˆåˆ›å»ºçº¿ç¨‹ï¼‰</li>
  <li>ä¾‹ç¨‹â€œTCPServerå’ŒTCPClientâ€	ï¼ˆä¼ é€æœåŠ¡å™¨æ—¶é—´ï¼‰</li>
  <li>è¯¾ä»¶â€œå¥—æ¥å­—å¹¶å‘ç¼–ç¨‹.PDFâ€</li>
  <li>Chatå®éªŒçš„è¯¾ä»¶</li>
</ul>

<h2 id="å®éªŒç¯å¢ƒ">å®éªŒç¯å¢ƒ</h2>

<ul>
  <li>Windows + VS 2012
    <ul>
      <li>å¯¹äºVS2015å’ŒVS2017é»˜è®¤ä½¿ç”¨å®‰å…¨å‘¨æœŸæ£€æŸ¥ï¼Œå¦‚æœä¸å…³é—­VSçš„å®‰å…¨å‘¨æœŸæ£€æŸ¥ï¼Œå¾ˆå¤šå­—ç¬¦ä¸²å‡½æ•°éƒ½ä¸èƒ½ç”¨ã€‚</li>
    </ul>
  </li>
  <li>Linux + gcc</li>
</ul>

<p>è¿™é‡Œæˆ‘ä½¿ç”¨çš„ç¯å¢ƒæ˜¯Windows 10 + VSCode + gcc version 8.1.0 (x86_64-posix-sjlj-rev0, Built by MinGW-W64 project)</p>

<h2 id="å®éªŒå†…å®¹">å®éªŒå†…å®¹</h2>

<p>å…ˆé˜…è¯»è¯¾ä»¶â€œå¥—æ¥å­—å¹¶å‘ç¼–ç¨‹.PDFâ€ã€‚é‡ç‚¹æ˜¯è¯»æ‡‚è¯¾ä»¶ä¸­â€œchatå¹¶å‘ç¼–ç¨‹(æœåŠ¡å™¨)â€å’Œâ€œchatå¹¶å‘ç¼–ç¨‹(å®¢æˆ·ç«¯)â€çš„æµç¨‹å›¾ã€‚ ç„¶åï¼Œå®Œæˆä¸‹é¢æ­¥éª¤ï¼ˆæˆªå±è¦åŒæ—¶æ˜¾ç¤ºæœåŠ¡å™¨å’Œè‡³å°‘ä¸¤ä¸ªå®¢æˆ·ç«¯ï¼‰ï¼š</p>

<ol>
  <li>ç¼–å†™å¤šäººèŠå¤©ç¨‹åºï¼Œè¦æ±‚å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨éƒ½é‡‡ç”¨å¤šçº¿ç¨‹æ–¹å¼è¿›è¡Œç¼–ç¨‹ã€‚æ¯ä¸ªå®¢æˆ·ç«¯éƒ½é‡‡ç”¨TCPåè®®è¿æ¥æœåŠ¡å™¨å¹¶ä¿æŒè¿æ¥ã€‚æœåŠ¡å™¨åŒæ—¶ä¸æ‰€æœ‰å®¢æˆ·ç«¯å»ºç«‹å’Œä¿æŒè¿æ¥ã€‚æ¯ä¸ªå®¢æˆ·ç«¯è¾“å…¥çš„æ¶ˆæ¯éƒ½ä¼šé€šè¿‡æœåŠ¡å™¨è½¬å‘ç»™æ‰€æœ‰å®¢æˆ·ã€‚</li>
  <li>æœåŠ¡å™¨ç¨‹åºè½¬å‘æŸä¸ªå®¢æˆ·ç«¯å‘æ¥çš„æ¶ˆæ¯æ—¶éƒ½åœ¨æ¶ˆæ¯å‰é¢åŠ ä¸Šè¯¥å®¢æˆ·ç«¯çš„IPåœ°å€å’Œç«¯å£å·ä»¥åŠæœåŠ¡å™¨çš„å½“å‰æ—¶é—´ã€‚è¦æ±‚æœåŠ¡å™¨ç¨‹åºæŠŠè½¬å‘çš„ æ¶ˆæ¯ä¹Ÿæ˜¾ç¤ºå‡ºæ¥ã€‚</li>
  <li>æ–°å®¢æˆ·åˆšè¿æ¥æ—¶æœåŠ¡å™¨ç«¯æŠŠâ€œenterâ€æ¶ˆæ¯ï¼ˆåŒ…å«å®¢æˆ·ç«¯IPåœ°å€å’Œç«¯å£å·ï¼‰å‘é€ç»™æ‰€æœ‰å®¢æˆ·ç«¯ã€‚</li>
  <li>å®¢æˆ·ç«¯è¾“å…¥exitæ—¶é€€å‡ºå®¢æˆ·ç«¯ç¨‹åºï¼ˆæ­£å¸¸é€€å‡ºï¼‰ï¼Œæˆ–è€…å®¢æˆ·ç«¯ç›´æ¥å…³é—­çª—å£é€€å‡ºï¼ˆå¼‚å¸¸é€€å‡ºï¼‰ï¼ŒæœåŠ¡å™¨éƒ½ä¼šæŠŠè¯¥å®¢æˆ·leaveçš„æ¶ˆæ¯å¹¿æ’­ç»™æ‰€æœ‰å®¢æˆ·ã€‚</li>
</ol>

<p>å®¢æˆ·ç«¯ç¨‹åºï¼š</p>

<pre><code class="language-c">#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
#include &lt;process.h&gt;
#include &lt;winsock2.h&gt;
#define BUFLEN 2000
#define WSVERS MAKEWORD(2, 0)
#pragma comment(lib, "ws2_32.lib")
int finish = 0;
unsigned __stdcall recvMessage(SOCKET *p)
{
	for (char buf[BUFLEN];;)
	{
		int cc = recv(*p, buf, BUFLEN, 0); // BUFLENä¸ºç¼“å†²åŒºbufçš„é•¿åº¦ï¼Œè¿”å›å€¼ï¼šæ¥æ”¶çš„å­—ç¬¦æ•°(&gt;0)ã€å¯¹æ–¹å·²å…³é—­(=0) æˆ–è¿æ¥å‡ºé”™(&lt;0)
		if (finish)
			return 0;
		if (cc &gt; 0)
		{
			buf[cc] = '\0';	//  ensure null-termination
			printf("%s", buf); // æ˜¾ç¤ºæ‰€æ¥æ”¶çš„å­—ç¬¦ä¸²
		}
		else if (cc == SOCKET_ERROR)
			printf("Recv Error:\n%d\n", GetLastError());
		else if (cc == 0)
			printf("Recv connect closed.\n");
	}
}
int main()
{
	char buf[BUFLEN];
	WSADATA wsadata;
	WSAStartup(WSVERS, &amp;wsadata);
	struct sockaddr_in sin; // an Internet endpoint address
	memset(&amp;sin, 0, sizeof(sin));
	sin.sin_family = AF_INET; // å› ç‰¹ç½‘åœ°å€ç°‡
	printf("Input the IP address:\n");
	gets(buf);
	sin.sin_addr.s_addr = inet_addr(buf); // æœåŠ¡å™¨IPåœ°å€(32ä½)
	printf("Input the IP port:\n");
	gets(buf);
	sin.sin_port = htons(atoi(buf));						 // æœåŠ¡å™¨ç«¯å£å·(16ä½)
	SOCKET sock = socket(PF_INET, SOCK_STREAM, IPPROTO_TCP); // socket descriptor
	int ret = connect(sock, &amp;sin, sizeof(sin));				 // è¿æ¥åˆ°æœåŠ¡å™¨.æ— é”™æ—¶ï¼Œè¿”å›0ï¼›å¦åˆ™ï¼Œè¿”å›SOCKET_ERROR ï¼Œå¯ä»¥è°ƒç”¨å‡½æ•°WSAGetLastErrorå–å¾—é”™è¯¯ä»£ç 
	HANDLE h = _beginthreadex(NULL, 0, &amp;recvMessage, &amp;sock, 0, NULL);
	for (;;)
	{
		gets(buf);
		if (!strcmp(buf, "exit"))
			break;
		int cc = send(sock, buf, strlen(buf), 0); //æŠŠç¼“å†²åŒºbufçš„æ•°æ®å‘é€å‡ºå»ï¼Œlenä¸ºè¦å‘é€çš„å­—èŠ‚æ•°ï¼Œè¿”å›å€¼ï¼š(&gt;0) å®é™…å‘é€çš„å­—èŠ‚æ•°(â‰¤len), (=0) å¯¹æ–¹æ­£å¸¸å…³é—­ï¼Œï¼ˆ=SOCKET_ERROR) å‡ºé”™ï¼Œç”¨å‡½æ•°WSAGetLastErrorå–é”™è¯¯ç ã€‚
		if (cc == SOCKET_ERROR)
			printf("Send Error:\n%d\n", GetLastError());
		else if (cc == 0)
			printf("Send connect closed.\n");
	}
	finish = 1;
	CloseHandle(h);
	closesocket(sock); // å…³é—­å¥—æ¥å­—
	WSACleanup();	  //  å¸è½½winsock library
	system("pause");
}
</code></pre>

<p>æœåŠ¡å™¨ç«¯ç¨‹åºï¼š</p>

<pre><code class="language-c">#include &lt;stdio.h&gt;
#include &lt;time.h&gt;
#include &lt;process.h&gt;
#include &lt;winsock2.h&gt;
#define BUFLEN 2000
#define WSVERS MAKEWORD(2, 0)
#pragma comment(lib, "ws2_32.lib") //ä½¿ç”¨winsock 2.2 library
SOCKET ssock[BUFLEN];			   //master &amp; *p sockets
struct sockaddr_in ssin[BUFLEN];
int sbadd[BUFLEN], ssock_size = 0;
unsigned __stdcall server(int *p)
{
	for (char msg[BUFLEN] = "Enter!", pts[BUFLEN];;)
	{
		time_t now = time(NULL);
		sprintf(pts,
				"ip: %d.%d.%d.%d port: %u\n"
				"time: %s"
				"message: %s\n"
				"\n&gt;&gt;",
				ssin[*p].sin_addr.S_un.S_un_b.s_b1,
				ssin[*p].sin_addr.S_un.S_un_b.s_b2,
				ssin[*p].sin_addr.S_un.S_un_b.s_b3,
				ssin[*p].sin_addr.S_un.S_un_b.s_b4,
				ssin[*p].sin_port,
				ctime(&amp;now),
				msg);
		printf(pts);
		for (int i = 0; i &lt; ssock_size; ++i)
			send(ssock[i], pts, strlen(pts), 0);
		if (!strcmp(msg, "Leave!"))
			return closesocket(ssock[*p]), 0; //å…³é—­è¿æ¥å¥—æ¥å­—
		int cc = recv(ssock[*p], msg, BUFLEN, 0);
		if (cc &gt; 0)
			msg[cc] = 0;
		else
			sprintf(msg, "Leave!");
	}
}
int main()
{
	WSADATA wsadata;
	WSAStartup(WSVERS, &amp;wsadata);							  //åŠ è½½winsock libraryï¼ŒWSVERSä¸ºè¯·æ±‚ç‰ˆæœ¬ï¼Œwsadataè¿”å›ç³»ç»Ÿå®é™…æ”¯æŒçš„æœ€é«˜ç‰ˆæœ¬
	struct sockaddr_in msin;								  //an Internet endpoint addresss
	memset(&amp;msin, 0, sizeof(msin));							  //ä»&amp;sinå¼€å§‹çš„é•¿åº¦ä¸ºsizeof(sin)çš„å†…å­˜æ¸…0 , sinä¸ºä¸€ä¸ªåœ°å€ç»“æ„
	msin.sin_family = AF_INET;								  //å› ç‰¹ç½‘åœ°å€ç°‡(INET-Internet)
	msin.sin_addr.s_addr = INADDR_ANY;						  //ç›‘å¬æ‰€æœ‰(æ¥å£çš„)IPåœ°å€(32ä½)ï¼Œ0.0.0.0
	msin.sin_port = htons(atoi("50500"));					  //ç›‘å¬çš„ç«¯å£å·(16ä½) ã€‚atoi--æŠŠasciiè½¬åŒ–ä¸ºintï¼Œhtonsâ€”ä¸»æœºåºåˆ°ç½‘ç»œåº
	SOCKET msock = socket(PF_INET, SOCK_STREAM, IPPROTO_TCP); //åˆ›å»ºå¥—æ¥å­—ã€‚å‚æ•°ï¼šå› ç‰¹ç½‘åè®®ç°‡(family)ï¼Œå­—èŠ‚æµï¼ŒTCPåè®®å·ã€‚ è¿”å›ï¼šè¦ç›‘å¬å¥—æ¥å­—çš„æè¿°ç¬¦æˆ–INVALID_SOCKET
	bind(msock, (struct sockaddr *)&amp;msin, sizeof(msin));	  //é€šè¿‡msinæŠŠè¦ç›‘å¬çš„IPåœ°å€å’Œç«¯å£å·ç»‘å®šåˆ°å¥—æ¥å­—ä¸Š
	listen(msock, 5);										  //å»ºç«‹é•¿åº¦ä¸º5çš„è¿æ¥è¯·æ±‚é˜Ÿåˆ—ï¼Œå¹¶å¼€å§‹ç›‘å¬æ˜¯å¦æœ‰è¿æ¥è¯·æ±‚åˆ°æ¥ï¼Œæ¥äº†åˆ™æ”¾å…¥é˜Ÿåˆ—
	printf("Server Start to listen.\n");
	while (!_kbhit()) //æ£€æµ‹æ˜¯å¦æœ‰æŒ‰é”® (ä»€ä¹ˆæ—¶å€™æ‰§è¡Œï¼Ÿ)
	{
		int alen = sizeof(struct sockaddr);												//from-address length
		ssock[ssock_size] = accept(msock, (struct sockaddr *)&amp;ssin[ssock_size], &amp;alen); //acceptï¼šå¦‚æœæœ‰æ–°çš„è¿æ¥è¯·æ±‚ï¼Œè¿”å›è¿æ¥å¥—æ¥å­—ï¼Œå¦åˆ™ï¼Œè¢«é˜»å¡ï¼ŒssinåŒ…å«å®¢æˆ·ç«¯IPåœ°å€å’Œç«¯å£å·
		sbadd[ssock_size] = ssock_size;
		_beginthreadex(NULL, 0, &amp;server, &amp;sbadd[ssock_size++], 0, NULL);
	}
	closesocket(msock);
	WSACleanup();
	system("pause");
}
</code></pre>

<p>è¿è¡Œæ•ˆæœå¦‚ä¸‹ï¼š
<img src="/public/image/2019-03-19-1.jpg" alt="å›¾ç‰‡æè¿°" /></p>

<p>æµ‹è¯•ä¸€ä¸‹å®¢æˆ·ç«¯æ˜¯å¦èƒ½å¤Ÿè¿ä¸Šè€å¸ˆåœ¨æ ¡å›­ç½‘æ­çš„æœåŠ¡å™¨ï¼ˆ172.18.187.9:50500ï¼‰ï¼š
è¿è¡Œæˆªå±ï¼ˆå®¢æˆ·ç«¯ï¼‰ï¼š
<img src="/public/image/2019-03-19-2.jpg" alt="å›¾ç‰‡æè¿°" /></p>

<p>å’ŒåŒå­¦äº’æµ‹ä¸€ä¸‹çœ‹çœ‹ï¼Œä½œä¸ºæœåŠ¡å™¨è¿è¡Œæˆªå±ï¼š
<img src="/public/image/2019-03-19-3.jpg" alt="å›¾ç‰‡æè¿°" />
ä½œä¸ºå®¢æˆ·ç«¯è¿è¡Œæˆªå±ï¼š
<img src="/public/image/2019-03-19-4.jpg" alt="å›¾ç‰‡æè¿°" /></p>

<h2 id="å®éªŒä½“ä¼š">å®éªŒä½“ä¼š</h2>

<ol>
  <li>åœ¨æœåŠ¡ç«¯çš„ç¨‹åºä¸­ï¼Œä¸€å¼€å§‹ä¼ æ–°è¿æ¥çš„ä¸‹æ ‡çš„æŒ‡é’ˆåˆ°å­çº¿ç¨‹çš„æ—¶å€™ç›´æ¥ä¼ äº†ä¸€ä¸ªå±€éƒ¨å˜é‡è¿‡å»ï¼Œç»“æœåœ¨æ–°å¼€çš„çº¿ç¨‹é‡Œå°±ä¼šå‡ºé”™ï¼›åŸå› æ˜¯å±€éƒ¨å˜é‡å·²ç»è¢«ææ„ã€‚éšåä½¿ç”¨ä¸€ä¸ªå…¨å±€æ•°ç»„ä½œä¸ºè¿‡æ¸¡ã€‚ä¸ºä»€ä¹ˆæ˜¯æ•°ç»„ï¼Ÿå› ä¸ºå‡è®¾åªç”¨ä¸€ä¸ªå˜é‡è¿›è¡Œè¿‡æ¸¡çš„è¯ï¼Œåœ¨æœ‰å¤šäººåŒæ—¶è¿æ¥ï¼Œæ–°å¼€å¤šä¸ªçº¿ç¨‹æ—¶å¯èƒ½è¯¥å˜é‡çš„å˜åŒ–æ—©äºæ–°å¼€çº¿ç¨‹çš„å‚æ•°ä¼ é€’ã€‚</li>
  <li>åœ¨å’ŒåŒå­¦æµ‹è¯•æ—¶æ²¡æœ‰å…³æ‰æœ¬æœºé˜²ç«å¢™ï¼Œå¯¼è‡´æ¥æ”¶ä¸åˆ°åŒå­¦å‘æ¥çš„æ¶ˆæ¯ã€‚</li>
  <li>å®¢æˆ·ç«¯è¾“å…¥exitä¸‹çº¿æ—¶ï¼Œå¦‚æœä¸æ¥å—çš„çº¿ç¨‹ä¸åŒæ—¶å…³é—­çš„è¯ä¼šä¸æ–­æŠ¥é”™ã€‚äºæ˜¯é¢å¤–ç”¨ä¸€ä¸ªå…¨å±€å˜é‡<code>finish</code>æ¥ä¸­è½¬ï¼Œå­çº¿ç¨‹åœ¨<code>finish</code>å€¼å˜åŒ–çš„æ—¶å€™ä¸å†æ¥å—æ¶ˆæ¯ã€‚</li>
</ol>
:ET