I"¢N<h2 id="å®éªŒé¢˜ç›®">å®éªŒé¢˜ç›®</h2>

<p>äºŒçŠ¶æ€è¿›ç¨‹æ¨¡å‹</p>

<h2 id="å®éªŒç›®çš„">å®éªŒç›®çš„</h2>

<ol>
  <li>å­¦ä¹ è¿›ç¨‹æ¨¡å‹çŸ¥è¯†ï¼ŒæŒæ¡è¿›ç¨‹æ¨¡å‹çš„å®ç°æ–¹æ³•ã€‚</li>
  <li>åˆ©ç”¨æ—¶é’Ÿä¸­æ–­ï¼Œè®¾è®¡æ—¶é’Ÿä¸­æ–­å¤„ç†è¿›è¡Œè¿›ç¨‹äº¤æ›¿æ‰§è¡Œ</li>
  <li>æ‰©å±•MyOSï¼Œå®ç°å¤šè¿›ç¨‹æ¨¡å‹çš„åŸå‹æ“ä½œç³»ç»Ÿã€‚</li>
</ol>

<h2 id="å®éªŒå†…å®¹">å®éªŒå†…å®¹</h2>

<p>åœ¨å®éªŒäº”çš„åŸºç¡€ä¸Šï¼Œè¿›åŒ–ä½ çš„åŸå‹æ“ä½œç³»ç»Ÿï¼ŒåŸå‹ä¿ç•™åŸæœ‰ç‰¹å¾çš„åŸºç¡€ä¸Šï¼Œè®¾è®¡æ»¡è¶³ä¸‹åˆ—è¦æ±‚çš„æ–°åŸå‹æ“ä½œç³»ç»Ÿï¼š</p>

<ol>
  <li>å†…æ ¸å®ç°ç®€å•è¿›ç¨‹æ¨¡å‹ï¼Œè¿›ç¨‹å…·æœ‰å°±ç»ªã€è¿è¡Œä¸¤ç§åŸºæœ¬çŠ¶æ€ã€‚å»ºè®®åœ¨cç¨‹åºä¸­å®šä¹‰è¿›ç¨‹è¡¨ï¼Œè¿›ç¨‹æ•°é‡æœ€å¤š4ä¸ªã€‚</li>
  <li>å†…æ ¸å¯ä»¥ä¸€æ¬¡æ€§åŠ è½½æœ€å¤š4ä¸ªç”¨æˆ·ç¨‹åºã€‚ç”¨æˆ·è¿›ç¨‹é‡‡ç”¨æ—¶é—´ç‰‡è½®è½¬è°ƒåº¦è¿›ç¨‹ã€‚ç”±ä½ è®¾è®¡æœ‰ä¸ªæ€§çš„ç”¨æˆ·ç¨‹åºï¼Œå®ƒä»¬çš„è¾“å‡ºå„å 1/4å±å¹•åŒºåŸŸï¼Œä¿¡æ¯è¾“å‡ºæœ‰åŠ¨æ„Ÿï¼Œä»¥ä¾¿è§‚å¯Ÿç¨‹åºæ˜¯å¦åœ¨æ‰§è¡Œã€‚</li>
  <li>åœ¨åŸå‹ä¸­ä¿è¯åŸæœ‰çš„ç³»ç»Ÿè°ƒç”¨æœåŠ¡å¯ç”¨ã€‚å†ç¼–å†™4ä¸ªç”¨æˆ·ç¨‹åºï¼Œå±•ç¤ºç³»ç»Ÿè°ƒç”¨æœåŠ¡è¿˜èƒ½å·¥ä½œã€‚</li>
</ol>

<h2 id="å®éªŒæ–¹æ¡ˆ">å®éªŒæ–¹æ¡ˆ</h2>

<h3 id="å®éªŒç¯å¢ƒ">å®éªŒç¯å¢ƒ</h3>

<h4 id="è½¯ä»¶">è½¯ä»¶</h4>

<ul>
  <li>Windows 10, 64-bit  (Build 17763) 10.0.17763</li>
  <li>Windows Subsystem for Linux [Ubuntu 18.04.2 LTS]ï¼šWSLæ˜¯ä»¥è½¯ä»¶çš„å½¢å¼è¿è¡Œåœ¨Windowsä¸‹çš„Linuxå­ç³»ç»Ÿï¼Œæ˜¯è¿‘äº›å¹´å¾®è½¯æ¨å‡ºæ¥çš„æ–°å·¥å…·ï¼Œå¯ä»¥åœ¨Windowsç³»ç»Ÿä¸ŠåŸç”Ÿè¿è¡ŒLinuxã€‚</li>
  <li>gcc version 7.3.0 (Ubuntu 7.3.0-27ubuntu1~18.04)ï¼šCè¯­è¨€ç¨‹åºç¼–è¯‘å™¨ï¼ŒUbuntuè‡ªå¸¦ã€‚</li>
  <li>NASM version 2.13.02ï¼šæ±‡ç¼–ç¨‹åºç¼–è¯‘å™¨ï¼Œé€šè¿‡<code>sudo apt install nasm</code>å®‰è£…åœ¨WSLä¸Šã€‚</li>
  <li>Oracle VM VirtualBox 6.0.6 r130049 (Qt5.6.2)ï¼šè½»é‡å¼€æºçš„è™šæ‹Ÿæœºè½¯ä»¶ã€‚</li>
  <li>VSCode - Insiders v1.33.0ï¼šå¥½ç”¨çš„æ–‡æœ¬ç¼–è¾‘å™¨ï¼Œæœ‰ä¸°å¯Œçš„æ’ä»¶ã€‚</li>
  <li>hexdump for VSCode 1.7.2: VSCodeä¸­ä¸€ä¸ªå¥½ç”¨çš„åå…­è¿›åˆ¶æ˜¾ç¤ºæ’ä»¶ã€‚</li>
  <li>GNU Make 4.1ï¼šå®‰è£…åœ¨Ubuntuä¸‹ï¼Œä¸€é”®ç¼–è¯‘å¹¶è¿æ¥ä»£ç ï¼Œç”Ÿæˆæœ€ç»ˆçš„æ–‡ä»¶ã€‚</li>
</ul>

<p>å¤§éƒ¨åˆ†å¼€å‘ç¯å¢ƒå®‰è£…åœ¨WSLä¸Šï¼Œè¾ƒä¹‹äºåŒç³»ç»Ÿã€è™šæ‹Ÿæœºç­‰å…¶ä»–å¼€å‘æ–¹æ¡ˆï¼Œæ›´åŠ æ–¹ä¾¿ï¼Œä¹Ÿæ–¹ä¾¿ç›´æ¥ä½¿ç”¨Linuxä¸‹çš„ä¸€äº›æŒ‡ä»¤ã€‚</p>

<h4 id="ç¡¬ä»¶">ç¡¬ä»¶</h4>

<h5 id="å¼€å‘ç¯å¢ƒé…ç½®">å¼€å‘ç¯å¢ƒé…ç½®</h5>

<p>æ‰€ç”¨æœºå™¨å‹å·ä¸ºVAIO Z Flip 2016</p>

<ul>
  <li>Intel(R) Core(TM) i7-6567U CPU @3.30GHZ 3.31GHz</li>
  <li>8.00GB RAM</li>
</ul>

<h5 id="è™šæ‹Ÿæœºé…ç½®">è™šæ‹Ÿæœºé…ç½®</h5>

<ul>
  <li>å¤„ç†å™¨å†…æ ¸æ€»æ•°ï¼š1</li>
  <li>RAMï¼š4MB</li>
</ul>

<h3 id="å®éªŒåŸç†">å®éªŒåŸç†</h3>

<p>æ—¶é’Ÿä¸­æ–­å“åº”åï¼Œä¿å­˜å½“å‰è¿›ç¨‹Açš„å¯„å­˜å™¨çŠ¶æ€ï¼›å¯»æ‰¾ä¸‹ä¸€ä¸ªè¿›ç¨‹B ï¼›è¿˜åŸè¿›ç¨‹Bçš„å¯„å­˜å™¨çŠ¶æ€ã€‚</p>

<h4 id="è®¾è®¡è¿›ç¨‹æ§åˆ¶å—å’Œscheduleè¿‡ç¨‹">è®¾è®¡è¿›ç¨‹æ§åˆ¶å—å’Œ<code>schedule</code>è¿‡ç¨‹</h4>

<p>é¦–å…ˆè¦æ˜ç¡®ï¼šéœ€è¦ä¿å­˜å¤šå°‘ä¸ªå¯„å­˜å™¨ã€‚</p>

<blockquote>
  <p>8086 è®¡ç®—æœºæœ‰ä»¥ä¸‹å¯„å­˜å™¨ï¼š</p>

  <ul>
    <li>æŒ‡ä»¤æŒ‡é’ˆå¯„å­˜å™¨ï¼šip</li>
    <li>æ®µå¯„å­˜å™¨ï¼šcs, es, ds, ss</li>
    <li>ä¸»å¯„å­˜å™¨ï¼šdi, si, bp, sp, ax, bx, cx, dx</li>
    <li>æ ‡å¿—å¯„å­˜å™¨</li>
  </ul>
</blockquote>

<p>æˆ‘ä½¿ç”¨å¦‚ä¸‹çš„Cè¯­è¨€ä»£ç æ¥ä½œä¸ºè¿›ç¨‹æ§åˆ¶å’Œè°ƒåº¦çš„è¿‡ç¨‹ï¼š</p>

<pre><code class="language-c">#define SCHEDULE_QUEUE_LEN 9
#define NEW 0
#define RUNNING 1
struct PCB
{
	int ip, cs, es, ds, ss, di, si, bp, sp, ax, bx, cx, dx, flags, pid;
} q[SCHEDULE_QUEUE_LEN], *qb = q, *qe = q + 1;
int statues[SCHEDULE_QUEUE_LEN] = {RUNNING, NEW}, pidStack[SCHEDULE_QUEUE_LEN], *top = pidStack;
void schedule()
{
	do
		if (++qb == q + SCHEDULE_QUEUE_LEN)
			qb = q;
	while (statues[qb-&gt;pid] != RUNNING);
	if (++qe == q + SCHEDULE_QUEUE_LEN)
		qe = q;
}
</code></pre>

<p>åœ¨è€å¸ˆç»™æˆ‘ä»¬çš„åŸå‹ä¸­æ˜¯ä¸ºæ¯ä¸ªç¨‹åºåˆ›å»ºä¸€å¼ è¡¨ï¼Œè¿™æ ·åšçš„ç¼ºç‚¹æœ‰ä¸¤ä¸ªï¼šä¸€ä¸ªæ˜¯æ¯ä¸ªç¨‹åºè‡³å¤šåªèƒ½åŒæ—¶è¿è¡Œä¸€ä¸ªï¼›å¦ä¸€ä¸ªæ˜¯åœ¨è°ƒåº¦æ—¶å¦‚æœåªåŠ è½½äº†å°‘æ•°è¿›ç¨‹ï¼Œä¹Ÿä»ç„¶éœ€è¦éå†æ£€æŸ¥æ‰€æœ‰çš„ç¨‹åºï¼Œä¼šæ‹–æ…¢æ“ä½œç³»ç»Ÿè¿è¡Œçš„é€Ÿåº¦ã€‚å› æ­¤æˆ‘åœ¨è¿™é‡Œå®ç°äº†ä¸€ä¸ªå¾ªç¯é˜Ÿåˆ—ï¼Œæ¯æ¬¡ä¿å­˜è¿›ç¨‹æ—¶å†™å…¥é˜Ÿå°¾ï¼Œè¿›ç¨‹æ¢å¤æ—¶ä»é˜Ÿé¦–å–ä¸€ä¸ªâ€œæœ‰æ•ˆâ€çš„è¿›ç¨‹å—å³å¯ã€‚æ‰€è°“â€œæœ‰æ•ˆâ€å°†åœ¨ä¸‹é¢â€œå…³é—­è¿›ç¨‹â€ä¸­è§£é‡Šã€‚</p>

<p>è¿™é‡Œä½¿ç”¨0å·pidä»£è¡¨å†…æ ¸è¿›ç¨‹ã€‚</p>

<h4 id="åˆ›å»ºè¿›ç¨‹">åˆ›å»ºè¿›ç¨‹</h4>

<p>é¦–å…ˆåˆ›å»ºè¿›ç¨‹æ§åˆ¶å—ï¼Œå°†<code>cs</code>,<code>ds</code>ç­‰å¯„å­˜å™¨è®¾ç½®ä¸ºåˆé€‚çš„å€¼ï¼Œç„¶åè®¾ç½®è¯¥è¿›ç¨‹ä¸ºâ€œå°±ç»ªâ€çŠ¶æ€ã€‚è€ƒè™‘åˆ°è¿›ç¨‹ç»“æŸååº”è¿”å›å†…æ ¸å¹¶å°†è¯¥è¿›ç¨‹çš„<code>statues</code>å±æ€§è®¾ç½®ä¸º<code>NEW</code>ï¼Œæ“ä½œç³»ç»Ÿåº”äº‹å…ˆåœ¨å…¶ç”¨æˆ·æ ˆå†…å†™å…¥è¿”å›<code>cs</code>å’Œè¿”å›<code>ip</code>ã€‚ç”¨æˆ·ç¨‹åºè¿”å›å†…æ ¸åï¼Œå°†<code>alive</code>å±æ€§è®¾ç½®ä¸º0ï¼Œæ­»å¾ªç¯ç­‰å¾…æ—¶é’Ÿä¸­æ–­å‘ç”Ÿã€‚æ—¶é’Ÿä¸­æ–­å‘ç”Ÿåï¼Œè¯¥è¿›ç¨‹ç»“æŸï¼Œä¸‹ä¸€æ¬¡æ—¶é—´ç‰‡è½®è½¬å°†ä¸å†è½®åˆ°å®ƒã€‚</p>

<p>æˆ‘å®ç°äº†ä¸€ä¸ªæ ˆç”¨æ¥åˆ†é…å½“å‰è¿›ç¨‹çš„pidï¼Œå³å½“å‰è¿›ç¨‹çš„æ ‡è¯†ã€‚è¿™æ ·åšçš„å¥½å¤„å’Œä¸Šé¢ä½¿ç”¨å¾ªç¯é˜Ÿåˆ—çš„å¥½å¤„ä¸€æ ·ï¼Œå¯ä»¥å‡å°‘åˆ†é…æ—¶å€™çš„ç©ºè½¬é—®é¢˜ã€‚æ­¤å¤–ï¼Œå½“æ ˆä¸ºç©ºçš„æ—¶å€™ï¼Œæˆ‘çš„æ“ä½œç³»ç»Ÿå¯ä»¥é‡æ–°åˆ†é…pidï¼Œä»è€Œå®ç°æ€è¿›ç¨‹çš„æ•ˆæœï¼Œé˜²æ­¢è¿›ç¨‹èµ„æºè¢«ç”¨æˆ·ç¨‹åºè¿‡å¤šå ç”¨è€Œä¸èƒ½æ–°å¼€è¿›ç¨‹ã€‚å½“ç„¶ï¼Œ0å·pidä»£è¡¨æ“ä½œç³»ç»Ÿå†…æ ¸ï¼Œå› æ­¤ä¸ä¼šè¢«é‡æ–°åˆ†é…ã€‚</p>

<h4 id="å…³é—­è¿›ç¨‹">å…³é—­è¿›ç¨‹</h4>

<p>æˆ‘è¿™é‡Œä½¿ç”¨äº†ä¼ªå…³é—­çš„æ–¹æ³•ï¼Œä¸æ˜¯ç›´æ¥å°†è¿›ç¨‹çš„æ§åˆ¶å—ç§»å‡ºé˜Ÿåˆ—ï¼Œè€Œæ˜¯å…ˆåœ¨çŠ¶æ€è¡¨ä¸­å°†å…¶ç½®ä¸ºå…³é—­ï¼Œç­‰å¾…è°ƒåº¦ç¨‹åºæ¥åˆ¤æ–­å½“å‰è¿›ç¨‹é˜Ÿåˆ—é¦–çš„è¿›ç¨‹æ˜¯å¦å·²è¢«å…³é—­ï¼Œå¦‚æœæ˜¯çš„è¯ç›´æ¥å‡ºé˜Ÿæ£€æŸ¥ä¸‹ä¸€ä¸ªè¿›ç¨‹ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªæœ‰æ•ˆçš„è¿›ç¨‹ã€‚ç”±äºå†…æ ¸è¿›ç¨‹æ˜¯ä¸å¯ä»¥è¢«æ€æ­»çš„ï¼Œå› æ­¤è¿›ç¨‹é˜Ÿåˆ—æ°¸è¿œä¸ä¸ºç©ºã€‚</p>

<pre><code class="language-c">statues[pid] = NEW, *++top = pid;
</code></pre>

<p>å…³é—­è¿›ç¨‹æ—¶å°†å…¶<code>pid</code>é‡æ–°å‹å›æ ˆä¸­ï¼Œä¾›ä¸‹ä¸€æ¬¡åˆ›å»ºè¿›ç¨‹æ—¶åˆ†é…ã€‚</p>

<p>å½“ç„¶ï¼Œåœ¨å½“å‰ç‰ˆæœ¬çš„å†…æ ¸ä¸­æ£€æµ‹é”®ç›˜ä¸­æ–­æ²¡æœ‰ç”¨å¤šè¿›ç¨‹å®ç°ï¼Œå› æ­¤åœ¨å¤šè¿›ç¨‹è¿è¡Œçš„æ—¶å€™å®é™…ä¸Šæ˜¯æ²¡æœ‰åŠæ³•é€€å›åˆ°å†…æ ¸çš„ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªå…³é—­è¿›ç¨‹çš„åŠŸèƒ½è™½ç„¶å®ç°æ˜¯æ­£ç¡®çš„ï¼Œä½†æ˜¯æš‚æ—¶æ²¡åŠæ³•å»æµ‹è¯•ã€‚ç­‰å¾…åç»­ç‰ˆæœ¬å®ç°å¤šè¿›ç¨‹å“åº”é”®ç›˜ä¸­æ–­ä¹‹åå§ã€‚</p>

<h4 id="saveå’Œrestartè¿‡ç¨‹"><code>save</code>å’Œ<code>restart</code>è¿‡ç¨‹</h4>

<p>ä¸­æ–­å‘ç”Ÿæ—¶ï¼Œç”±CPUå°†æ ‡å¿—å¯„å­˜å™¨<code>flags</code>ã€ä»£ç æ®µå¯„å­˜å™¨<code>cs</code>ã€æŒ‡ä»¤æŒ‡é’ˆå¯„å­˜å™¨<code>ip</code>ä¾æ¬¡å‹å…¥å †æ ˆï¼ˆè¢«ä¸­æ–­çš„ç¨‹åºçš„å †æ ˆï¼‰ï¼›ä¸­æ–­è¿”å›æ—¶ï¼ˆå³æ‰§è¡Œ<code>iret</code>æŒ‡ä»¤æ—¶ï¼‰ï¼ŒCPUå°†å †æ ˆä¸­çš„æŒ‡ä»¤æŒ‡é’ˆå¯„å­˜å™¨<code>ip</code>ã€ä»£ç æ®µå¯„å­˜å™¨<code>cs</code>ã€æ ‡å¿—å¯„å­˜å™¨<code>flags</code>ä¾æ¬¡å¼¹å‡ºå †æ ˆï¼Œå¹¶è½¬åˆ°<code>CS:IP</code>ç»§ç»­åŸç¨‹åºçš„æ‰§è¡Œã€‚ç…§ç€æ–‡æ¡£ï¼Œæˆ‘è¯»æ‡‚äº†è€å¸ˆæä¾›çš„â€œç°åœºä¿æŠ¤â€ï¼š<code>save</code>è¿‡ç¨‹ï¼ˆæ—§ç‰ˆï¼‰ä»£ç å’Œç°åœºæ¢å¤<code>restart</code>è¿‡ ç¨‹ï¼ˆæ—§ç‰ˆï¼‰ä»£ç ã€‚æˆ‘è®¡åˆ’<code>schedule</code>è¿‡ç¨‹ç”±C å®ç°ï¼Œæ•…<code>save</code>è¿‡ç¨‹åªéœ€å°†å¯„å­˜å™¨ä¿å­˜åœ¨å¤–éƒ¨å˜é‡ï¼ˆCè¯­è¨€çš„å˜é‡ï¼‰ï¼Œ ç„¶å<code>restore</code>è¿‡ç¨‹éœ€è¦å°†å¤–éƒ¨å˜é‡è¿˜åŸåˆ°å¯„å­˜å™¨ä¸­ã€‚å¦‚æ­¤å®‰æ’ï¼Œ<code>schedule</code>è¿‡ç¨‹è¦åšçš„äº‹æƒ…æ˜¯ï¼šå°†Cè¯­è¨€çš„å˜é‡ä¿å­˜åˆ°Aè¿›ç¨‹æ§åˆ¶å—ä¸­ï¼Œç„¶åè°ƒåº¦å¦ä¸€è¿›ç¨‹Bï¼Œå°†<code>B</code>è¿›ç¨‹æ§åˆ¶å—ä¸­çš„å¯„å­˜å™¨å†™å…¥Cè¯­è¨€çš„å˜é‡ã€‚</p>

<pre><code class="language-nasm">	call save
	pusha
	push ds
	push es

	push 0
	call schedule
restart:
	pop es
	pop ds
	popa

	mov si,[qb]
	mov es,word[si+12];es
	mov ss,word[si+20];ss
	mov ax,word[si+24];ax
	mov bx,word[si+28];bx
	mov cx,word[si+32];cx
	mov dx,word[si+36];dx
	mov di,word[si+40];di
	mov bp,word[si+44];bp
	mov sp,word[si+48];sp

	push word[si+8]
	push word[si+4]
	push word[si]

	push word[si+52]
	push word[si+16];ds
	pop ds
	pop si

	push ax
	mov al,20h
	out 20h,al
	out 0A0h,al
	pop ax
	iret
save:
	push ds
	push cs
	pop ds
	pop word[save_ds]
	pop word[save_cs]

	mov word[save_si],si
	mov si,word[qe]

	pop word [si]
	pop word [si+4]
	pop word [si+8]

	mov word [si+12],es
	push word [save_ds]
	pop word [si+16]

	mov word[si+20],ss
	mov word[si+24],ax
	mov word[si+28],bx
	mov word[si+32],cx
	mov word[si+36],dx
	mov word[si+40],di
	mov word[si+44],bp
	mov word[si+48],sp
	push word[save_pid]
	push word[save_si]
	pop word[si+52]
	pop word[si+56]
	jmp word[save_cs]
</code></pre>

<p>è¿™é‡Œä¿å­˜å˜é‡ç›´æ¥ä¿å­˜åœ¨Cä»£ç ä¸­çš„é˜Ÿå°¾<code>qe</code>ï¼Œå¹¶åœ¨è°ƒåº¦åä»Cä»£ç ä¸­çš„é˜Ÿé¦–<code>qb</code>ä¸­å–å‡ºå˜é‡æ¢å¤å³å¯ã€‚</p>

<h2 id="å®éªŒè¿‡ç¨‹">å®éªŒè¿‡ç¨‹</h2>

<h3 id="å®éªŒä»£ç ">å®éªŒä»£ç </h3>

<h4 id="bootloaderasm">bootloader.asm</h4>

<p>å’Œ<a href="https://wu-kan.github.io/posts/æ“ä½œç³»ç»Ÿ/å®éªŒ/ç³»ç»Ÿè°ƒç”¨">ä¸Šä¸€ä¸ªå®éªŒ</a>ä¸­çš„ä»£ç å®Œå…¨ç›¸åŒï¼Œä¸å†æ”¾å‡ºã€‚</p>

<h4 id="kernelasm">kernel.asm</h4>

<p>å®ç°ç³»ç»Ÿä¸­æ–­å’Œæ—¶é’Ÿä¸­æ–­ã€‚</p>

<pre><code class="language-nasm">%macro setIVT 2
	push es
	push ds
	push si
	pusha
	xor ax, ax
	mov es, ax
	mov ax, %1
	mov bx, 4
	mul bx
	mov si, ax
	mov ax, %2
	mov [es:si], ax
	add si, 2
	mov ax, cs
	mov [es:si], ax
	popa
	pop si
	pop ds
	pop es
%endmacro
	bits 16
	extern qb,qe,schedule,terminal,prgCall
	global _start
_start:
	setIVT 33,int33
	setIVT 8,int8
	push 0
	call terminal
	ret
int8:
	cli
	call save
	pusha
	push ds
	push es

	push 0
	call schedule
restart:
	pop es
	pop ds
	popa

	mov si,[qb]
	mov es,word[si+12];es
	mov ss,word[si+20];ss
	mov ax,word[si+24];ax
	mov bx,word[si+28];bx
	mov cx,word[si+32];cx
	mov dx,word[si+36];dx
	mov di,word[si+40];di
	mov bp,word[si+44];bp
	mov sp,word[si+48];sp

	push word[si+8]
	push word[si+4]
	push word[si]

	push word[si+52]
	push word[si+16];ds
	pop ds
	pop si

	push ax
	mov al,20h
	out 20h,al
	out 0A0h,al
	pop ax
	sti
	iret
save:
	push ds
	push cs
	pop ds
	pop word[save_ds]
	pop word[save_cs]

	mov word[save_si],si
	mov si,word[qe]

	pop word [si]
	pop word [si+4]
	pop word [si+8]

	mov word [si+12],es
	push word [save_ds]
	pop word [si+16]

	mov word[si+20],ss
	mov word[si+24],ax
	mov word[si+28],bx
	mov word[si+32],cx
	mov word[si+36],dx
	mov word[si+40],di
	mov word[si+44],bp
	mov word[si+48],sp
	push word[save_pid]
	push word[save_si]
	pop word[si+52]
	pop word[si+56]
	jmp word[save_cs]

int33:
	cli
	mov al,ah
	xor ah,ah
	push eax
	push 0
	call prgCall
	pop eax
	sti
	iret
datadef:
	save_cs dw 0
	save_si dw 0
	save_ds dw 0
	save_pid dw 0
</code></pre>

<h3 id="kernerc">kerner.c</h3>

<p>å®ç°äºŒçŠ¶æ€è¿›ç¨‹è°ƒåº¦åŠŸèƒ½ï¼Œå‰é¢å·²ç»è§£é‡Šè¿‡äº†ã€‚</p>

<p>æ­¤å¤–ï¼Œä¿®å¤äº†æ»šå±çš„æ—¶å€™æœ‰æ—¶ä¼šå‡ºç°ç°å±çš„é—®é¢˜ï¼ˆå¿˜è®°ç»™<code>bh</code>å¯„å­˜å™¨èµ‹å€¼äº†ï¼‰ã€‚</p>

<pre><code class="language-c">#define SCREEN_WIDTH 80
#define SCREEN_HEIGHT 25
#define BUF_LEN (SCREEN_WIDTH * SCREEN_HEIGHT)
#define PROGRAM_NUM 4
#define SCHEDULE_QUEUE_LEN 5
#define NEW 0
#define RUNNING 1
struct PCB
{
	int ip, cs, es, ds, ss, di, si, bp, sp, ax, bx, cx, dx, flags, pid;
} q[SCHEDULE_QUEUE_LEN], *qb = q, *qe = q + 1;
int statues[SCHEDULE_QUEUE_LEN] = {RUNNING, NEW}, pidStack[SCHEDULE_QUEUE_LEN], *top = pidStack;
void schedule()
{
	do
		if (++qb == q + SCHEDULE_QUEUE_LEN)
			qb = q;
	while (statues[qb-&gt;pid] != RUNNING);
	if (++qe == q + SCHEDULE_QUEUE_LEN)
		qe = q;
}
const struct
{
	const char *name, *size, *command;
	int address;
} prg[PROGRAM_NUM] =
	{{"prg1", "    156 bytes", "prg1", 1},
	 {"prg2", "    158 bytes", "prg2", 2},
	 {"prg3", "    168 bytes", "prg3", 3},
	 {"prg4", "    174 bytes", "prg4", 4}};
void loadProgram(int PrgSectorOffset, int UserPrgOffset)
{
	asm("int 0x13"
		:
		: "a"(2 &lt;&lt; 8 | 1), "b"(UserPrgOffset), "c"(PrgSectorOffset), "d"(1 &lt;&lt; 8));
}
void call(int UserPrgOffset)
{
	asm("call bx"
		:
		: "b"(UserPrgOffset));
}
void prgCall(int i)
{
	loadProgram(prg[i].address, 0x0a100 + i * 0x100), call(0x0a100 + i * 0x100);
}
int getCursor()
{
	int p;
	asm("int 0x10"
		: "=d"(p)
		: "a"(0x0300), "b"(0));
	return p;
}
void setCursor(int pos)
{
	asm("int 0x10"
		:
		: "a"(0x0200), "b"(0), "d"(pos));
}
void pageUP(int p)
{
	asm("push bx\n"
		"mov bh,0\n"
		"int 0x10\n"
		"pop bx\n"
		:
		: "a"(1536 + p), "c"(0), "d"(0x184F));
}
void putC(int ch, int color)
{
	asm("int 0x10"
		:
		: "a"(9 &lt;&lt; 8 | ch), "b"(color), "c"(1));
}
int getch()
{
	int ch;
	asm("getch_loop:\n"
		"mov ah, 0x01\n"
		"int 0x16\n"
		"jz getch_loop\n"
		"mov ah, 0x00\n"
		"int 0x16\n"
		"xor ah, ah\n"
		: "=a"(ch)
		:);
	return ch;
}
void putchar(char c)
{
	int cur = getCursor(), curX = cur &gt;&gt; 8, curY = cur - (curX &lt;&lt; 8);
	if (c == '\r' || c == '\n')
	{
		if (++curX &gt;= SCREEN_HEIGHT)
			--curX, pageUP(1);
		return setCursor(curX &lt;&lt; 8);
	}
	putC(c, 0x07);
	if (++curY &gt;= SCREEN_WIDTH)
		putchar('\n');
	else
		setCursor(curX &lt;&lt; 8 | curY);
}
void gets(char *s)
{
	for (;; ++s)
	{
		putchar(*s = getch());
		if (*s == '\r' || *s == '\n')
			break;
	}
	*s = 0;
}
void printf(const char *s)
{
	for (; *s; ++s)
		putchar(*s);
}
int strcmp(const char *s1, const char *s2)
{
	while (*s1 &amp;&amp; (*s1 == *s2))
		++s1, ++s2;
	return (int)*s1 - (int)*s2;
}
void terminal()
{
	char str[BUF_LEN] = "$ ";
	printf(str), gets(str);
	const char
		*CLEAR_COM = "clear",
		*HELP_COM = "help",
		*EXEC_COM = "exec",
		*EXECPRO_COM = "execpro",
		*EXIT_COM = "exit",
		*KILL_COM = "kill",
		*LS_COM = "ls",
		*PS_COM = "ps";
	if (!strcmp(str, CLEAR_COM))
		pageUP(SCREEN_HEIGHT), setCursor(0);
	else if (!strcmp(str, HELP_COM))
	{
		const char
			*HELP_INFO =
				"WuK-shell v0.0.3\n"
				"These shell commands are defined internally.\n"
				"Command         Description\n"
				"clear        -- Clean the screen\n"
				"help         -- Show this list\n"
				"exec         -- Execute all the user programs\n"
				"execpro      -- Execute all the user programs by mutiprocess\n"
				"exit         -- Exit OS\n"
				"kill         -- kill process\n"
				"ls           -- Show existing programs\n"
				"prg[num]     -- Execute the num-th program\n"
				"ps           -- Show running programs with their pid\n";
		printf(HELP_INFO);
	}
	else if (!strcmp(str, EXEC_COM))
		for (int i = 0; i &lt; PROGRAM_NUM; ++i)
			prgCall(i);
	else if (!strcmp(str, EXECPRO_COM))
		for (int i = 0; i &lt; PROGRAM_NUM; ++i)
		{
			if (top == pidStack)
				for (int j = 1; j &lt; SCHEDULE_QUEUE_LEN; ++j)
					*++top = j;

			qe-&gt;flags = 512;
			qe-&gt;ip = 0x000;
			qe-&gt;sp = qe-&gt;ip - 8;
			qe-&gt;ss = qe-&gt;es = qe-&gt;ds = qe-&gt;cs = 0xa100 + i * 0x100;

			loadProgram(prg[i].address, 0x0a100 + i * 0x100);
			statues[qe-&gt;pid = *(top--)] = RUNNING;
			if (++qe == q + SCHEDULE_QUEUE_LEN)
				qe = q;
		}
	else if (!strcmp(str, EXIT_COM))
		return pageUP(SCREEN_HEIGHT);
	else if (!strcmp(str, KILL_COM))
	{
		const char *INFO = "Input the pid to kill: ";
		printf(INFO);
		gets(str);
		int pid = str[0] - '0';
		if (pid &lt;= 0)
		{
			const char *INFO = "Can not kill process 0.\n";
			printf(INFO);
		}
		else if (pid &gt;= SCHEDULE_QUEUE_LEN || statues[pid] != RUNNING)
		{
			const char *INFO = "Invalid pid.\n";
			printf(INFO);
		}
		else
			statues[pid] = NEW, *++top = pid;
	}
	else if (!strcmp(str, LS_COM))
		for (int i = 0; i &lt; PROGRAM_NUM; ++i)
			printf(prg[i].name), printf(prg[i].size), putchar('\n');
	else if (!strcmp(str, PS_COM))
	{
		const char
			*INFO = "pid statues\n",
			*RUNNING_INFO = "   RUNNING\n",
			*NEW_INFO = "   NEW\n";
		printf(INFO);
		for (int i = 0; i &lt; SCHEDULE_QUEUE_LEN; ++i)
		{
			putchar('0' + i);
			printf(statues[i] == RUNNING ? RUNNING_INFO : NEW_INFO);
		}
	}
	else
		for (int i = 0;; ++i)
		{
			if (i == PROGRAM_NUM)
			{
				printf(str);
				const char
					*COMM_NOT_FOUND =
						" : command not found, type \'help\' for available commands list.\n";
				printf(COMM_NOT_FOUND);
				break;
			}
			if (!strcmp(str, prg[i].command))
			{
				asm("int 33" ::"a"(i &lt;&lt; 8));
				break;
			}
		}
	terminal();
}
</code></pre>

<h4 id="linkld">link.ld</h4>

<p>å°†<code>wukos.asm</code>å’Œ<code>kernel.c</code>ä¸¤ä¸ªæ–‡ä»¶ç¼–è¯‘å‡ºæ¥çš„å†…å®¹è¿æ¥èµ·æ¥ã€‚å’Œ<a href="https://wu-kan.github.io/posts/æ“ä½œç³»ç»Ÿ/å®éªŒ/ç³»ç»Ÿæ§åˆ¶">ä¸Šä¸€ä¸ªå®éªŒ</a>ä¸­çš„å®Œå…¨ç›¸åŒï¼Œä¸å†æ”¾å‡ºã€‚</p>

<h4 id="prg1asmprg4asm">prg1.asm~prg4.asm</h4>

<p>ç”±äºå¤šè¿›ç¨‹è°ƒç”¨æ—¶ä¼šåŒæ—¶è®¿é—®å˜é‡ï¼Œå› æ­¤æ¯ä¸ªç”¨æˆ·ç¨‹åºéœ€è¦é‡æ–°ç»´æŠ¤è‡ªå·±çš„è¿è¡Œå˜é‡ï¼Œè€Œä¸èƒ½åƒä¹‹å‰ä¸€æ ·é€šè¿‡ç³»ç»Ÿè°ƒç”¨æä¾›å”¯ä¸€ä¸ªå…¥å£äº†ã€‚</p>

<p>è¿™é‡Œåœ¨å®éªŒäºŒä¸­å®ç°çš„ç”¨æˆ·ç¨‹åºä¸Šä¿®æ”¹ã€å®Œå–„ä¸€ä¸‹ã€‚</p>

<pre><code class="language-nasm">%macro print 5 ; string, length, x, y, color
	pusha
	push ax
	push bx
	push cx
	push dx
	push bp
	push ds
	push es
	mov ax, 0b800H
	mov gs, ax
	mov ax, cs
	mov ds, ax
	mov bp, %1
	mov ax, ds
	mov es, ax
	mov cx, %2
	mov ax, 1300H
	mov dh, %3
	mov dl, %4
	mov bx, %5
	int 10H
	pop es
	pop ds
	pop bp
	pop dx
	pop cx
	pop bx
	pop ax
	popa
%endmacro
N equ 12	;æ˜¾ç¤ºåŒºåŸŸé«˜åº¦
M equ 32	;æ˜¾ç¤ºåŒºåŸŸå®½åº¦å‡å»å­—ç¬¦ä¸²é•¿åº¦
TOP equ 2	;æ˜¾ç¤ºåŒºåŸŸä¸Šç«¯ç‚¹
LEFT equ 40	;æ˜¾ç¤ºåŒºåŸŸå·¦ç«¯ç‚¹
LENGTH equ 8	;å­—ç¬¦ä¸²çš„é•¿åº¦
DELAY equ 99999999
org 0A100h
myLoop:
	dec dword[count]	; é€’å‡è®¡æ•°å˜é‡
	jnz myLoop	; &gt;0ï¼šè·³è½¬
	mov dword[count], DELAY

	mov word ax, [t]	; ax = t
	mov word bx,2*N-2
	xor dx, dx	; clear dx and prepare for division
	div bx  ; dx = t mod (2N - 2)
	cmp dx, N ; compare dx and n
	jb xok  ; if (dx &lt; n) jump xok
	sub bx, dx
	mov dx, bx ; dx = 2n - 2 - dx
xok:
	mov word[x], dx
	add word[x], TOP

	mov word ax, [t]
	mov word bx, 2*M-2
	xor dx, dx
	div bx
	cmp dx, M
	jb yok
	sub bx, dx
	mov dx, bx
yok:
	mov word [y],dx
	add word [y],LEFT

	print message,LENGTH,[x],[y],07H
	inc word[t]
	mov word ax,[t]
	cmp ax, 63
	jne myLoop
	ret
datadef:
	count dd 1
	t dw 0
	x dw 1
	y dw 0
	message db ' wu-kan '
</code></pre>

<p>ä¸Šé¢æ˜¯prg1.asmçš„å†…å®¹ï¼Œå…¶ä½™åŒç†ï¼Œä¸å†æ”¾å‡ºã€‚</p>

<h4 id="makefile">Makefile</h4>

<p>å’Œ<a href="https://wu-kan.github.io/posts/æ“ä½œç³»ç»Ÿ/å®éªŒ/ç³»ç»Ÿæ§åˆ¶">ä¸Šä¸€ä¸ªå®éªŒ</a>å®Œå…¨ç›¸åŒï¼Œä¸å†æ”¾å‡ºã€‚</p>

<h3 id="è¿è¡Œç»“æœ">è¿è¡Œç»“æœ</h3>

<p>è¾“å…¥<code>prg4</code>ï¼Œé€šè¿‡ç³»ç»Ÿä¸­æ–­æ‰“å¼€ä¸€ä¸ªç”¨æˆ·ç¨‹åºã€‚å¯ä»¥çœ‹åˆ°ç³»ç»Ÿä¸­æ–­æœåŠ¡ä»ç„¶å¯ä»¥å·¥ä½œã€‚
<img src="/public/image/2019-05-06-1.jpg" alt="1" />
è¾“å…¥<code>ps</code>ï¼Œæ˜¾ç¤ºå½“å‰è¿›ç¨‹çš„çŠ¶æ€ã€‚å½“å‰åªæœ‰ä¸€ä¸ªè¿›ç¨‹ï¼Œå³å†…æ ¸ï¼Œåœ¨è¿è¡Œã€‚
<img src="/public/image/2019-05-06-2.jpg" alt="2" />
è¾“å…¥<code>kill</code>åè¾“å…¥<code>0</code>ï¼Œæ€æ‰pidä¸º0çš„å†…æ ¸ã€‚å¯ä»¥çœ‹åˆ°æ— æ³•æ€æ‰å†…æ ¸è¿›ç¨‹ã€‚
<img src="/public/image/2019-05-06-3.jpg" alt="3" />
è¾“å…¥<code>execpro</code>ï¼Œå¤šè¿›ç¨‹çš„æ‰“å¼€å››ä¸ªç”¨æˆ·ç¨‹åºã€‚å¯ä»¥çœ‹åˆ°ï¼ŒæˆåŠŸæ–‡ä½“å››å¼€èŠ±äº†ï¼Œè€Œä¸”å››ä¸ªè±¡é™çš„è¿è¡Œé€Ÿåº¦ä¸ä¸€æ ·ã€‚
<img src="/public/image/2019-05-06-4.jpg" alt="4" /></p>

<h2 id="å®éªŒæ€»ç»“">å®éªŒæ€»ç»“</h2>

<p>è¿™æ¬¡å®éªŒè®©æˆ‘æ·±å…¥äº†è§£äº†å¤šè¿›ç¨‹æ—¶é—´ç‰‡è½®è½¬çš„å·¥ä½œåŸç†ã€‚åŸç†å¾ˆç®€å•ï¼Œå°±æ˜¯<code>save</code>,<code>schedule</code>å’Œ<code>restart</code>ï¼Œä½†å®ç°èµ·æ¥å¯ä¸ç®€å•ã€‚</p>

<p>åœ¨<code>save</code>è¿‡ç¨‹å’Œ<code>restart</code>è¿‡ç¨‹ä¸­ï¼Œæœ€å®¹æ˜“å‡ºé”™æ˜¯æ ˆã€‚å½“å‰æ ˆå†…å…ƒç´ æ˜¯ä»€ä¹ˆï¼Œè¿™ä¸ªä¸€å®šè¦éå¸¸æ¸…æ¥šã€‚å½“ä½¿ç”¨<code>call</code>æ“ä½œå’Œ<code>ret</code>æ“ä½œæ—¶ï¼Œä¼šä¿®æ”¹å †æ ˆã€‚æ‰€ä»¥åº”å°½é‡é¿å…ä½¿ç”¨<code>call</code>å’Œ<code>ret</code>æ“ä½œï¼Œé¿å…å‡ºé”™ã€‚å¦å¤–ï¼Œ<code>ss</code>å’Œ<code>sp</code>çš„ä¿å­˜æ—¶æœºä¹Ÿæ˜¯éå¸¸å…³é”®çš„ã€‚<code>ss</code>å’Œ<code>sp</code>å¿…é¡»åœ¨æœ€åä¿å­˜ï¼Œè¿™æ ·åšæ˜¯ä¸ºäº†ä¿å­˜å¼¹å‡º<code>flags</code>,<code>cs</code>,<code>ip</code>ä¹‹åçš„æ ˆæŒ‡é’ˆã€‚</p>

<p>åœ¨<code>schedule</code>è¿‡ç¨‹ä¸­ï¼Œæ›´å®¹æ˜“åœ¨æ ˆçš„é—®é¢˜ä¸Šå‡ºé”™ã€‚<code>schedule</code>çš„æ ˆè¦ä¸<code>kernel</code>çš„æ ˆä»¥åŠç”¨æˆ·ç¨‹åºçš„æ ˆéƒ½ä¸ä¸€æ ·ï¼Œå¦åˆ™ä¼šè¦†ç›–åŸæœ‰çš„æ•°æ®ã€‚ä¸€æ—¦è¸©è¿›è¿™ä¸ªå‘ï¼Œå°±å¾ˆéš¾è·³å‡ºæ¥ï¼Œå› ä¸ºä½ ä¼šå‘ç°å¯„å­˜å™¨ä¹‹ç±»çš„å…¨éƒ¨éƒ½æ˜¯å¯¹çš„ï¼Œåªæœ‰æ ˆå†…å…ƒç´ æ˜¯é”™çš„ã€‚</p>

<p>å¦å¤–åœ¨æ±‡ç¼–ä»£ç è°ƒç”¨Cå‡½æ•°ä¹‹å‰è¦<code>push 0</code>ï¼Œä¼ å‚æ•°çš„æ—¶å€™ä¹Ÿæœ‰å¾ˆå¤šç»†èŠ‚ï¼Œæ„Ÿè°¢æˆ‘çš„å®¤å‹æ·»ä¼¦å¤§å“¥å¯¹æˆ‘çš„å¸®åŠ©ï¼</p>
:ET