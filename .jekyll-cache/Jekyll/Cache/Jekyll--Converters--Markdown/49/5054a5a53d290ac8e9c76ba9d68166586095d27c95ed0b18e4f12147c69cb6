I"ã<h2 id="é—®é¢˜æè¿°">é—®é¢˜æè¿°</h2>

<p>è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼ˆRPCï¼‰å°†ç½‘ç»œç¼–ç¨‹å˜å¾—éå¸¸ç®€å•ã€‚æ ¹æ®æ‰€å­¦çš„RPCç›¸å…³åŸç†ï¼Œå®ç°å®¢æˆ·ç«¯-æœåŠ¡å™¨é€šä¿¡ï¼Œå¹¶è¿›è¡Œç®€å•çš„è®¡ç®—å¦‚æ•°æ®åº“æŸ¥è¯¢ã€ç®—æœ¯è®¡ç®—ã€æ•°æ®æŒ–æ˜ã€æ·±åº¦å­¦ä¹ æ¨å¯¼ç­‰ã€‚</p>

<h3 id="è¦æ±‚">è¦æ±‚</h3>

<ol>
  <li>é‡‡ç”¨gRPC</li>
  <li>é‡‡ç”¨Protobufä½œä¸ºC-Sæ•°æ®ä¼ è¾“æ ¼å¼</li>
  <li>æœåŠ¡å™¨ç«¯é‡‡ç”¨çº¿ç¨‹æ± ï¼Œæ”¯æŒå¹¶å‘</li>
  <li>æ”¯æŒè‡³å°‘ä¸¤ç§çš„è®¡ç®—æœåŠ¡å¦‚ç®€å•çš„ç®—æœ¯è¿ç®—+æ•°æ®æŒ–æ˜ç®—æ³•ï¼ˆK-meansã€KNNç­‰ï¼‰</li>
  <li>ç¼–ç¨‹è¯­è¨€ä¸åšè¦æ±‚</li>
</ol>

<h3 id="å»ºè®®">å»ºè®®</h3>

<p>gRPCå’ŒProtobufåœ¨é…ç½®ç¯å¢ƒæ—¶å¯èƒ½æœ‰äº›å¤æ‚ï¼Œ å¯¹äºæœ‰äº›ç¼–ç¨‹è¯­è¨€å¦‚C++ã€goç­‰ä¼šæœ‰ä¸€äº›æŒ‘æˆ˜ï¼Œ Pythoné—®é¢˜ä¼šå°‘ä¸€äº›ã€‚</p>

<h2 id="è§£å†³æ–¹æ¡ˆ">è§£å†³æ–¹æ¡ˆ</h2>

<p>äººç”Ÿè‹¦çŸ­ï¼Œé€‰æ‹©Pythonã€‚</p>

<h3 id="å¼€å‘ç¯å¢ƒ">å¼€å‘ç¯å¢ƒ</h3>

<h4 id="ç¡¬ä»¶">ç¡¬ä»¶</h4>

<p>æ‰€ç”¨æœºå™¨å‹å·ä¸ºVAIO Z Flip 2016</p>

<ul>
  <li>Intel(R) Core(TM) i7-6567U CPU @3.30GHZ 3.31GHz</li>
  <li>8.00GB RAM</li>
</ul>

<h4 id="è½¯ä»¶">è½¯ä»¶</h4>

<ul>
  <li>Windows 10, 64-bit (Build 17763) 10.0.17763</li>
  <li>Visual Studio Code 1.39.2
    <ul>
      <li>Python 2019.10.41019ï¼šä¹æœˆåº•å‘å¸ƒçš„VSCode Pythonæ’ä»¶æ”¯æŒåœ¨ç¼–è¾‘å™¨çª—å£å†…åŸç”Ÿè¿è¡Œjuyter nootbookäº†ï¼Œéå¸¸èµï¼</li>
      <li>Remote - WSL 0.39.9ï¼šé…åˆWSLï¼Œåœ¨Windowsä¸Šè·å¾—Linuxæ¥è¿‘åŸç”Ÿç¯å¢ƒçš„ä½“éªŒã€‚</li>
    </ul>
  </li>
  <li>Windows Subsystem for Linux [Ubuntu 18.04.2 LTS]ï¼šWSLæ˜¯ä»¥è½¯ä»¶çš„å½¢å¼è¿è¡Œåœ¨Windowsä¸‹çš„ Linuxå­ç³»ç»Ÿï¼Œæ˜¯è¿‘äº›å¹´å¾®è½¯æ¨å‡ºæ¥çš„æ–°å·¥å…·ï¼Œå¯ä»¥åœ¨Windowsç³»ç»Ÿä¸ŠåŸç”Ÿè¿è¡ŒLinuxã€‚
    <ul>
      <li>Python 3.7.4 64-bit (â€˜anaconda3â€™:virtualenv)ï¼šå®‰è£…åœ¨WSLä¸­ã€‚</li>
    </ul>
  </li>
</ul>

<h5 id="å®‰è£…grpcçš„pythonç¯å¢ƒ">å®‰è£…<code>gRPC</code>çš„<code>python</code>ç¯å¢ƒ</h5>

<pre><code class="language-bash">python -m pip install grpcio grpcio-tools
</code></pre>

<h3 id="æºä»£ç ">æºä»£ç </h3>

<p>è¿™é‡Œå®ç°äº†ç®€å•çš„æ±‚é˜¶ä¹˜è¿ç®—å’ŒåŸºäº<code>sklearn</code>å®ç°çš„KNNç®—æ³•ã€‚</p>

<h4 id="wuk_hw3proto"><code>wuk_hw3.proto</code></h4>

<pre><code class="language-proto">syntax = "proto3";
service Greeter {
    rpc KNN(KNNargs) returns (Vector) {}
    rpc CalculateFactorial(Int32) returns (Int32) {}
}
message Vector {
    repeated float value = 1;
}
message Matrix {
    repeated Vector value=1;
}
message KNNargs {
    Vector train_y = 1;
    Matrix train_x = 2;
    Matrix test_x = 3;
}
message Int32 {
    int32 value = 1;
}
</code></pre>

<h4 id="wuk_hw3_serverpy"><code>wuk_hw3_server.py</code></h4>

<pre><code class="language-python">from sklearn.neighbors import KNeighborsClassifier
import numpy as np
from concurrent import futures
import logging
import grpc
import wuk_hw3_pb2
import wuk_hw3_pb2_grpc


class Greeter(wuk_hw3_pb2_grpc.GreeterServicer):
    def KNN(self, request, context):
        testx, trainx, trainy = [], [], []
        for row in request.test_x.value:
            tmp = []
            for it in row.value:
                tmp.append(it)
            testx.append(tmp)
        for row in request.train_x.value:
            tmp = []
            for it in row.value:
                tmp.append(it)
            trainx.append(tmp)
        for it in request.train_y.value:
            trainy.append(it)
        knn = KNeighborsClassifier()
        knn.fit(np.array(trainx), np.array(trainy))
        return wuk_hw3_pb2.Vector(value=knn.predict(np.array(testx)).tolist())

    def CalculateFactorial(self, request, context):
        ans = 1
        for i in range(request.value):
            ans = ans*(i+1)
        return wuk_hw3_pb2.Int32(value=ans)


if __name__ == '__main__':
    logging.basicConfig()
    server = grpc.server(futures.ThreadPoolExecutor(max_workers=10))
    wuk_hw3_pb2_grpc.add_GreeterServicer_to_server(Greeter(), server)
    server.add_insecure_port('[::]:50051')
    server.start()
    server.wait_for_termination()
</code></pre>

<h4 id="wuk_hw3_clientpy"><code>wuk_hw3_client.py</code></h4>

<pre><code class="language-python">from __future__ import print_function
from sklearn.model_selection import train_test_split
from sklearn import datasets
import logging
import grpc
import wuk_hw3_pb2
import wuk_hw3_pb2_grpc

if __name__ == '__main__':
    logging.basicConfig()
    stub = wuk_hw3_pb2_grpc.GreeterStub(
        grpc.insecure_channel('localhost:50051'))
    iris = datasets.load_iris()
    X_train, X_test, Y_train, Y_test = train_test_split(iris.data, iris.target)
    X_train, Y_train, trainx, testx = X_train.tolist(), Y_train.tolist(), [], []
    for row in X_train:
        trainx.append(wuk_hw3_pb2.Vector(value=row))
    for row in X_test:
        testx.append(wuk_hw3_pb2.Vector(value=row))
    print("using knn to test iris\'dataset: ", X_test.tolist())
    res = stub.KNN(wuk_hw3_pb2.KNNargs(
        train_x=wuk_hw3_pb2.Matrix(value=trainx), train_y=wuk_hw3_pb2.Vector(value=Y_train),
        test_x=wuk_hw3_pb2.Matrix(value=testx)))
    res_list = []
    for ele in res.value:
        res_list.append(ele)
    print("result: ", res_list)
    fac = stub.CalculateFactorial(wuk_hw3_pb2.Int32(value=9))
    print("9! = ", str(fac.value))
</code></pre>

<h2 id="å®éªŒç»“æœ">å®éªŒç»“æœ</h2>

<h3 id="ç¼–è¯‘protobuf">ç¼–è¯‘Protobuf</h3>

<p>è¿è¡Œä¸‹è¿°ä»£ç ä¹‹åï¼Œç›®å½•ä¸‹ç”Ÿæˆ<code>wuk_hw3_pb2.py</code>å’Œ<code>wuk_hw3_pb2_grpc.py</code>ä¸¤ä¸ªæ–‡ä»¶ã€‚</p>

<pre><code class="language-bash">python -m grpc_tools.protoc --python_out=. --grpc_python_out=. -I. wuk_hw3.proto
</code></pre>

<h3 id="æœåŠ¡ç«¯">æœåŠ¡ç«¯</h3>

<p>è¿è¡Œä¸‹è¿°ä»£ç ï¼Œå¯åŠ¨æœåŠ¡å™¨è¿›ç¨‹ã€‚</p>

<pre><code class="language-bash">python wuk_hw3_server.py
</code></pre>

<h3 id="å®¢æˆ·ç«¯">å®¢æˆ·ç«¯</h3>

<p>æ–°å¼€ç»ˆç«¯è¿è¡Œä¸‹è¿°ä»£ç ï¼Œå¯åŠ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨è¿›è¡Œé€šä¿¡ã€‚å¯ä»¥çœ‹åˆ°ï¼ŒæˆåŠŸè¾“å‡ºäº†åœ¨<code>sklearn</code>çš„æ ·ä¾‹æ•°æ®é›†ä¸Šè·‘<code>KNN</code>ç®—æ³•çš„ç»“æœå’Œä¹çš„é˜¶ä¹˜ã€‚</p>

<pre><code class="language-bash">$ python wuk_hw3_client.py
using knn to test iris'dataset:  [[7.1, 3.0, 5.9, 2.1], [5.7, 3.0, 4.2, 1.2], [5.9, 3.0, 5.1, 1.8], [5.7, 2.8, 4.5, 1.3], [7.7, 3.0, 6.1, 2.3], [6.5, 3.2, 5.1, 2.0], [5.2, 3.4, 1.4, 0.2], [5.6, 2.9, 3.6, 1.3], [4.6, 3.1, 1.5, 0.2], [5.5, 3.5, 1.3, 0.2], [6.0, 3.4, 4.5, 1.6], [6.8, 3.0, 5.5, 2.1], [7.9, 3.8, 6.4, 2.0], [6.1, 3.0, 4.9, 1.8], [6.8, 3.2, 5.9, 2.3], [6.0, 3.0, 4.8, 1.8], [6.2, 2.8, 4.8, 1.8], [6.3, 2.5, 5.0, 1.9], [6.7, 3.3, 5.7, 2.1], [6.3, 2.9, 5.6, 1.8], [4.9, 3.1, 1.5, 0.1], [7.7, 3.8, 6.7, 2.2], [6.0, 2.2, 4.0, 1.0], [4.4, 2.9, 1.4, 0.2], [5.8, 2.7, 3.9, 1.2], [4.9, 2.4, 3.3, 1.0], [4.5, 2.3, 1.3, 0.3], [4.9, 3.0, 1.4, 0.2], [5.8, 2.7, 5.1, 1.9], [5.0, 3.4, 1.6, 0.4], [5.7, 2.8, 4.1, 1.3], [6.0, 2.7, 5.1, 1.6], [6.3, 2.8, 5.1, 1.5], [4.8, 3.1, 1.6, 0.2], [5.1, 2.5, 3.0, 1.1], [5.1, 3.8, 1.5, 0.3], [6.6, 2.9, 4.6, 1.3], [6.7, 3.0, 5.2, 2.3]]
result:  [2.0, 1.0, 2.0, 1.0, 2.0, 2.0, 0.0, 1.0, 0.0, 0.0, 1.0, 2.0, 2.0, 1.0, 2.0, 1.0, 1.0, 2.0, 2.0, 2.0, 0.0, 2.0, 1.0, 0.0, 1.0, 1.0, 0.0, 0.0, 2.0, 0.0, 1.0, 2.0, 1.0, 0.0, 1.0, 0.0, 1.0, 2.0]
9! =  362880
</code></pre>

<h2 id="é‡åˆ°çš„é—®é¢˜åŠè§£å†³æ–¹æ³•">é‡åˆ°çš„é—®é¢˜åŠè§£å†³æ–¹æ³•</h2>

<p>åªè¦ä»£ç èƒ½è·‘èµ·æ¥ï¼Œå¾ˆå¤šéš¾é¢˜æ…¢æ…¢éƒ½ä¼šå¾—åˆ°è§£å†³ã€‚å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼Œå†™äº†ç¬¬ä¸€ä¸ª<code>gRPC</code>çš„<code>HelloWorld</code>ç¤ºä¾‹ï¼Œéšåè¦æ±‚çš„åŠŸèƒ½å‡åœ¨æ­¤ä¹‹ä¸Šä¸€ç‚¹ç‚¹å¢é‡å¼€å‘å‡ºæ¥ã€‚</p>

<ul>
  <li><a href="https://grpc.io/docs/quickstart/python/">Python Quick Start</a></li>
  <li><a href="https://grpc.io/docs/tutorials/basic/python/">gRPC Basics - Python</a></li>
</ul>
:ET